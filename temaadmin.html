<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Tema Matrimonio</title>
<style>
    :root {
        --bg-color: #ffffff;
        --bg-color-secondario: #eeeeee;
        --text-color: #000000;
        --header-color: #007bff;
        --header-text: #ffffff;
    }

    body {
        font-family: var(--font-family, Arial, sans-serif);
        background-color: var(--bg-color);
        color: var(--text-color);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        padding: 1rem;
    }

    header {
        background-color: var(--header-color);
        color: var(--header-text);
        padding: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    main {
        flex: 1;
        display: flex;
        gap: 1rem;
        margin-top: 1rem;
    }

    .form-box, .preview-box {
        background: white;
        padding: 1rem;
        border-radius: 8px;
        flex: 1;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    .preview-box {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 300px;
    }

    select, input[type=color], input[type=text] {
        width: 100%;
        margin-bottom: 0.5rem;
        padding: 0.3rem;
    }

    button {
        padding: 0.5rem 1rem;
        cursor: pointer;
        margin-top: 0.5rem;
    }
</style>
</head>
<body>
<header>
    <h1>Amministrazione Tema Matrimonio</h1>
</header>

<main>
    <div class="form-box">
        <h2>Impostazioni Tema</h2>
        <label>Colore Sfondo Primario: <input type="color" id="bgColor"></label>
        <label>Colore Sfondo Secondario: <input type="color" id="bgColorSecondario"></label>
        <label>Colore Testo: <input type="color" id="textColor"></label>
        <label>Colore Header: <input type="color" id="headerColor"></label>
        <label>Testo Header: <input type="text" id="headerText"></label>
        <label>Font: <select id="fontsSelect"></select></label>
        <label>Effetto Scritta: <select id="effettiScrittaSelect"></select></label>
        <label>Effetto Sfondo: <select id="effettiSfondoSelect"></select></label>
        <label>Logo: <input type="file" id="logoInput"></label>
        <button id="saveThemeBtn">Salva Tema</button>
    </div>

    <div class="preview-box" id="previewBox">
        <h2>Anteprima</h2>
        <p id="previewText">Testo Anteprima</p>
    </div>
</main>

<script>
const backendBase = "https://matrimonioapp.ew.r.appspot.com";

const bgColorInput = document.getElementById("bgColor");
const bgColorSecondarioInput = document.getElementById("bgColorSecondario");
const textColorInput = document.getElementById("textColor");
const headerColorInput = document.getElementById("headerColor");
const headerTextInput = document.getElementById("headerText");
const fontsSelect = document.getElementById("fontsSelect");
const effettiScrittaSelect = document.getElementById("effettiScrittaSelect");
const effettiSfondoSelect = document.getElementById("effettiSfondoSelect");
const logoInput = document.getElementById("logoInput");
const saveThemeBtn = document.getElementById("saveThemeBtn");
const previewBox = document.getElementById("previewBox");
const previewText = document.getElementById("previewText");

let fonts = [], effettiScritta = [], effettiSfondo = [];

// --- Carica fonts ---
async function caricaFonts() {
    const res = await fetch(`${backendBase}/admin/get_fonts`);
    const data = await res.json();
    fonts = data.fonts || [];
    fontsSelect.innerHTML = "";
    fonts.forEach(f => {
        const option = document.createElement("option");
        option.value = f.css_family;
        option.textContent = f.name;
        fontsSelect.appendChild(option);
    });
}

// --- Carica effetti ---
async function caricaEffetti() {
    const res = await fetch(`${backendBase}/admin/get_effetti`);
    const data = await res.json();
    effettiScritta = data.scritta || [];
    effettiSfondo = data.sfondo || [];

    effettiScrittaSelect.innerHTML = "";
    effettiScritta.forEach(eff => {
        const option = document.createElement("option");
        option.value = eff.id;
        option.textContent = eff.name;
        effettiScrittaSelect.appendChild(option);
    });

    effettiSfondoSelect.innerHTML = "";
    effettiSfondo.forEach(eff => {
        const option = document.createElement("option");
        option.value = eff.id;
        option.textContent = eff.name;
        effettiSfondoSelect.appendChild(option);
    });
}

// --- Aggiorna anteprima ---
function aggiornaAnteprima() {
    document.documentElement.style.setProperty("--bg-color", bgColorInput.value);
    document.documentElement.style.setProperty("--bg-color-secondario", bgColorSecondarioInput.value);
    document.documentElement.style.setProperty("--text-color", textColorInput.value);
    document.documentElement.style.setProperty("--header-color", headerColorInput.value);
    document.documentElement.style.setProperty("--header-text", headerTextInput.value);
    document.documentElement.style.setProperty("--font-family", fontsSelect.value);

    // Applica effetto scritta
    const effScritta = effettiScritta.find(e => e.id === effettiScrittaSelect.value);
    if(effScritta) {
        previewText.style.cssText = effScritta.css;
        previewText.style.fontFamily = fontsSelect.value;
    } else {
        previewText.style.cssText = `color: ${textColorInput.value}; font-family: ${fontsSelect.value};`;
    }

    // Applica effetto sfondo
    const effSfondo = effettiSfondo.find(e => e.id === effettiSfondoSelect.value);
    if(effSfondo) {
        previewBox.style.cssText = effSfondo.css;
    } else {
        previewBox.style.cssText = `background-color: ${bgColorInput.value};`;
    }
}

// --- Carica tema esistente ---
async function caricaTema() {
    const res = await fetch(`${backendBase}/admin/get_theme?admin=default`);
    const data = await res.json();
    if(!data.success) return;

    const config = data.config;

    bgColorInput.value = config.bg_color || "#ffffff";
    bgColorSecondarioInput.value = config.bg_color_secondario || "#eeeeee";
    textColorInput.value = config.text_color || "#000000";
    headerColorInput.value = config.header_color || "#007bff";
    headerTextInput.value = config.header_text || "Header di esempio";
    fontsSelect.value = config.font_family || "Arial, sans-serif";
    effettiScrittaSelect.value = config.effetto_scritta || "";
    effettiSfondoSelect.value = config.effetto_sfondo || "";

    aggiornaAnteprima();
}

// --- Salva tema ---
async function salvaTema() {
    const formData = new FormData();
    formData.append("bg_color", bgColorInput.value);
    formData.append("bg_color_secondario", bgColorSecondarioInput.value);
    formData.append("text_color", textColorInput.value);
    formData.append("header_color", headerColorInput.value);
    formData.append("header_text", headerTextInput.value);
    formData.append("font_family", fontsSelect.value);
    formData.append("effetto_scritta", effettiScrittaSelect.value);
    formData.append("effetto_sfondo", effettiSfondoSelect.value);
    if(logoInput.files[0]) formData.append("logo", logoInput.files[0]);

    const res = await fetch(`${backendBase}/admin/save_theme?admin=default`, {
        method: "POST",
        body: formData
    });

    const data = await res.json();
    if(data.success) alert("Tema salvato correttamente!");
    else alert("Errore salvataggio tema");
}

// --- Event listeners ---
[bgColorInput, bgColorSecondarioInput, textColorInput, headerColorInput, headerTextInput, fontsSelect, effettiScrittaSelect, effettiSfondoSelect].forEach(el => {
    el.addEventListener("input", aggiornaAnteprima);
});

saveThemeBtn.addEventListener("click", salvaTema);

// --- Init ---
async function init() {
    await caricaFonts();
    await caricaEffetti();
    await caricaTema();
}

init();
</script>
</body>
</html>
