<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Admin Matrimonio</title>
<link rel="stylesheet" href="style.css">
<style>
/* Anteprima pi√π proporzionata */
.preview-box {
  margin-top: 20px;
  padding: 20px;
  width: 100%;
  max-width: 600px;
  min-height: 150px;
  background: #f0f0f0;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  box-sizing: border-box;
  position: relative;
}
.overlay {
  position: absolute;
  top:0; left:0; right:0; bottom:0;
  pointer-events: none;
  border-radius: 12px;
}
</style>
	  <script src="navbar.js" defer></script>
	  <script src="script.js" defer></script>
</head>
<body>
  <!-- Navbar -->
  <div id="navbar-container"></div>
  
<header>
  <h1>Admin Matrimonio</h1>
</header>

<div class="form-box">
  <h2>Impostazioni Tema</h2>
  <label>Colore Sfondo Primario:</label>
  <input type="color" id="bgColorInput" value="#ffffff"><br><br>
  <label>Colore Sfondo Secondario:</label>
  <input type="color" id="bgColorSecondarioInput" value="#eeeeee"><br><br>
  <label>Colore Testo:</label>
  <input type="color" id="textColorInput" value="#000000"><br><br>
  <label>Font:</label>
  <select id="fontsSelect"></select><br><br>
  <label>Effetto Scritta:</label>
  <select id="effettiScrittaSelect"></select><br><br>
  <label>Effetto Sfondo:</label>
  <select id="effettiSfondoSelect"></select><br><br>
  <button id="saveBtn">Salva Tema</button>
</div>

<div class="preview-box" id="previewBox">Anteprima Testo</div>

<script>
async function checkAuth() {
    const token = localStorage.getItem("auth_token");
    if(!token) window.location.href = "login.html";

    try {
        const res = await fetch("https://matrimonioapp.ew.r.appspot.com/me", { 
            headers: { "Authorization": "Bearer " + token }
        });
        const data = await res.json();
        if(!data.success){
            localStorage.removeItem("auth_token");
            localStorage.removeItem("admin_username");
            window.location.href = "login.html";
        }
    } catch(err){
        localStorage.removeItem("auth_token");
        localStorage.removeItem("admin_username");
        window.location.href = "login.html";
    }
}

// Dropdown menu utente
const userBtn = document.getElementById('userBtn');
const dropdownMenu = document.getElementById('dropdownMenu');
userBtn.querySelector('span').textContent = localStorage.getItem('admin_username') || 'Admin';
userBtn.addEventListener('click', () => {
    dropdownMenu.style.display = dropdownMenu.style.display === 'block' ? 'none' : 'block';
});

// Logout
function logout() {
    localStorage.removeItem("auth_token");
    localStorage.removeItem("admin_username");
    window.location.href = "login.html";
}

// Tema admin
const previewBox = document.getElementById('previewBox');
const bgColorInput = document.getElementById('bgColorInput');
const bgColorSecondarioInput = document.getElementById('bgColorSecondarioInput');
const textColorInput = document.getElementById('textColorInput');
const fontsSelect = document.getElementById('fontsSelect');
const effettiScrittaSelect = document.getElementById('effettiScrittaSelect');
const effettiSfondoSelect = document.getElementById('effettiSfondoSelect');
const saveBtn = document.getElementById('saveBtn');

let effettiScritta = [];
let effettiSfondo = [];
let fonts = [];

function hexToRgb(hex) {
  hex = hex.replace('#','');
  if(hex.length === 3) hex = hex.split('').map(c => c+c).join('');
  const bigint = parseInt(hex,16);
  const r = (bigint >> 16) & 255;
  const g = (bigint >> 8) & 255;
  const b = bigint & 255;
  return `${r}, ${g}, ${b}`;
}

// Carica fonts ed effetti
async function caricaFontsEdEffetti() {
  try {
    const token = localStorage.getItem("auth_token");
    const resFonts = await fetch("https://matrimonioapp.ew.r.appspot.com/admin/get_fonts", {
        headers: { "Authorization": "Bearer " + token }
    });
    const dataFonts = await resFonts.json();
    fonts = dataFonts.fonts;
    fontsSelect.innerHTML = '';
    fonts.forEach(f => {
      const option = document.createElement('option');
      option.value = f.css_family;
      option.textContent = f.name;
      fontsSelect.appendChild(option);
    });

    const resEffetti = await fetch("https://matrimonioapp.ew.r.appspot.com/admin/get_effetti", {
        headers: { "Authorization": "Bearer " + token }
    });
    const dataEffetti = await resEffetti.json();
    effettiScritta = dataEffetti.scritta;
    effettiSfondo = dataEffetti.sfondo;

    effettiScrittaSelect.innerHTML = '';
    effettiScritta.forEach(e => {
      const option = document.createElement('option');
      option.value = e.id;
      option.textContent = e.name;
      effettiScrittaSelect.appendChild(option);
    });

    effettiSfondoSelect.innerHTML = '';
    effettiSfondo.forEach(e => {
      const option = document.createElement('option');
      option.value = e.id;
      option.textContent = e.name;
      effettiSfondoSelect.appendChild(option);
    });
  } catch(e){ console.error(e); }
}

// Anteprima
function aggiornaAnteprima() {
  previewBox.style.cssText = '';
  previewBox.style.fontFamily = fontsSelect.value;
  previewBox.style.color = textColorInput.value;
  previewBox.style.display = 'flex';
  previewBox.style.alignItems = 'center';
  previewBox.style.justifyContent = 'center';
  previewBox.style.fontSize = '24px';
  previewBox.style.minHeight = '150px';
  previewBox.style.padding = '20px';

  const bgRgb = hexToRgb(bgColorInput.value);
  const bgSecondarioRgb = hexToRgb(bgColorSecondarioInput.value);

  previewBox.style.setProperty('--bg-color', bgColorInput.value);
  previewBox.style.setProperty('--bg-color-rgb', bgRgb);
  previewBox.style.setProperty('--bg-color-secondario', bgColorSecondarioInput.value);
  previewBox.style.setProperty('--bg-color-secondario-rgb', bgSecondarioRgb);

  const effScritta = effettiScritta.find(e => e.id === effettiScrittaSelect.value);
  if(effScritta && effScritta.css){
    let scrittaCss = effScritta.css.replace(/var\(--text-color\)/g, textColorInput.value);
    scrittaCss.split(';').forEach(rule => {
      if(rule.trim()){
        let [prop, ...rest] = rule.split(':');
        let val = rest.join(':');
        if(prop && val) previewBox.style.setProperty(prop.trim(), val.trim());
      }
    });
  }

  const effSfondo = effettiSfondo.find(e => e.id === effettiSfondoSelect.value);
  let overlayColor = `rgba(${bgRgb},0.3)`;
  if(effSfondo && effSfondo.css){
    let sfondoCss = effSfondo.css
      .replace(/var\(--bg-color\)/g, bgColorInput.value)
      .replace(/var\(--bg-color-rgb\)/g, bgRgb)
      .replace(/var\(--bg-color-secondario\)/g, bgColorSecondarioInput.value)
      .replace(/var\(--bg-color-secondario-rgb\)/g, bgSecondarioRgb);

    sfondoCss.split(';').forEach(rule => {
      if(rule.trim()){
        let [prop, ...rest] = rule.split(':');
        let val = rest.join(':');
        if(prop && val) previewBox.style.setProperty(prop.trim(), val.trim());
      }
    });

    const bgImageMatch = sfondoCss.match(/url\(([^)]+)\)/);
    if(bgImageMatch){
      previewBox.style.position = 'relative';
      if(!previewBox.querySelector('.overlay')){
        const overlay = document.createElement('div');
        overlay.className = 'overlay';
        overlay.style.backgroundColor = overlayColor;
        previewBox.appendChild(overlay);
      } else {
        previewBox.querySelector('.overlay').style.backgroundColor = overlayColor;
      }
    } else {
      const existingOverlay = previewBox.querySelector('.overlay');
      if(existingOverlay) existingOverlay.remove();
    }
  }
}

[bgColorInput, bgColorSecondarioInput, textColorInput, fontsSelect, effettiScrittaSelect, effettiSfondoSelect]
  .forEach(el => el.addEventListener('input', aggiornaAnteprima));

saveBtn.addEventListener('click', async () => {
  const formData = new FormData();
  formData.append('bg_color', bgColorInput.value);
  formData.append('bg_color_secondario', bgColorSecondarioInput.value);
  formData.append('text_color', textColorInput.value);
  formData.append('font_family', fontsSelect.value);
  formData.append('effetto_scritta', effettiScrittaSelect.value);
  formData.append('effetto_sfondo', effettiSfondoSelect.value);

  try {
    const token = localStorage.getItem("auth_token");
    const username = localStorage.getItem('admin_username') || 'default';
    const res = await fetch(`https://matrimonioapp.ew.r.appspot.com/admin/save_theme?admin=${encodeURIComponent(username)}`, {
      method: 'POST',
      headers: { "Authorization": "Bearer " + token },
      body: formData
    });
    const data = await res.json();
    if(data.success) alert('Tema salvato!');
    else alert('Errore salvataggio tema');
  } catch(e) { console.error('Errore save theme:', e); }
});

window.onload = async () => {
  await checkAuth();
  await caricaFontsEdEffetti();
  aggiornaAnteprima();
};

</script>
</body>
</html>
