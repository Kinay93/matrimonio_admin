<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Tema Admin</title>
<link rel="stylesheet" href="style.css">
<style>
  #anteprimaTema {
    width: 100%;
    height: 300px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid #ccc;
    border-radius: 8px;
    transition: all 0.3s ease;
  }
</style>
</head>
<body>
<header><h1>Gestione Tema Admin</h1></header>

<div class="container">
  <div class="form-col">
    <label>Colore sfondo:<input type="color" id="bgColor" value="#ffffff"></label>
    <label>Colore testo:<input type="color" id="textColor" value="#000000"></label>
    <label>Colore header:<input type="color" id="headerColor" value="#007BFF"></label>
    <label>Testo header:<input type="text" id="headerText" value="Amministrazione Matrimonio"></label>
    <label>Font:<select id="fontSelect"></select></label>
    <label>Effetto scritta:<select id="effettiScrittaSelect"></select></label>
    <label>Effetto sfondo:<select id="effettiSfondoSelect"></select></label>
    <label>Logo:<input type="file" id="logoFile"></label>
    <button id="saveTema">Salva Tema</button>
  </div>

  <div class="anteprima-col">
    <h3>Anteprima Tema</h3>
    <div id="anteprimaTema">Anteprima colori, font e effetti</div>
  </div>
</div>

<script src="script.js"></script>
<script>
const anteprima = document.getElementById("anteprimaTema");
const bgInput = document.getElementById("bgColor");
const textInput = document.getElementById("textColor");
const headerInput = document.getElementById("headerColor");
const headerTextInput = document.getElementById("headerText");
const fontSelect = document.getElementById("fontSelect");
const effettiScrittaSelect = document.getElementById("effettiScrittaSelect");
const effettiSfondoSelect = document.getElementById("effettiSfondoSelect");

let fonts = [];
let effettiScritta = [];
let effettiSfondo = [];

// ----------- CARICA DATI DAL BACKEND -----------
async function caricaFonts() {
  try {
    const res = await fetch("https://matrimonioapp.ew.r.appspot.com/admin/get_fonts");
    fonts = await res.json();
    fontSelect.innerHTML = "";
    fonts.fonts.forEach(f => {
      const o = document.createElement("option");
      o.value = f.id;
      o.textContent = f.name;
      fontSelect.appendChild(o);
    });
  } catch(e){ console.error("Errore caricamento fonts:", e); }
}

async function caricaEffetti() {
  try {
    const res = await fetch("https://matrimonioapp.ew.r.appspot.com/admin/get_effetti");
    const data = await res.json();
    effettiScritta = data.scritta;
    effettiSfondo = data.sfondo;

    effettiScrittaSelect.innerHTML = "";
    effettiScritta.forEach(eff => {
      const o = document.createElement("option");
      o.value = eff.id;
      o.textContent = eff.name;
      effettiScrittaSelect.appendChild(o);
    });

    effettiSfondoSelect.innerHTML = "";
    effettiSfondo.forEach(eff => {
      const o = document.createElement("option");
      o.value = eff.id;
      o.textContent = eff.name;
      effettiSfondoSelect.appendChild(o);
    });
  } catch(e){ console.error("Errore caricamento effetti:", e); }
}

// ----------- AGGIORNA ANTEPRIMA -----------
function aggiornaAnteprima() {
  anteprima.style.backgroundColor = bgInput.value;
  anteprima.style.color = textInput.value;

  const font = fonts.fonts.find(f => f.id === fontSelect.value);
  if(font) anteprima.style.fontFamily = font.css_family;

  const effScritta = effettiScritta.find(e => e.id === effettiScrittaSelect.value);
  if(effScritta) anteprima.style.cssText += effScritta.css;

  const effSfondo = effettiSfondo.find(e => e.id === effettiSfondoSelect.value);
  if(effSfondo) anteprima.style.cssText += effSfondo.css;

  const header = document.querySelector("header h1");
  if(header){
    header.textContent = headerTextInput.value;
    header.style.backgroundColor = headerInput.value;
    header.style.color = textInput.value;
  }
}

// ----------- LISTENER INPUT -----------
[bgInput,textInput,fontSelect,headerTextInput,headerInput,effettiScrittaSelect,effettiSfondoSelect]
.forEach(el => el.addEventListener("input", aggiornaAnteprima));

// ----------- SAVE TEMA -----------
document.getElementById("saveTema").addEventListener("click", async ()=>{
  const formData = new FormData();
  formData.append("bg_color", bgInput.value);
  formData.append("text_color", textInput.value);
  formData.append("header_color", headerInput.value);
  formData.append("header_text", headerTextInput.value);

  const font = fonts.fonts.find(f => f.id === fontSelect.value);
  formData.append("font_family", font ? font.css_family : "Arial, sans-serif");
  
  formData.append("effetto_scritta", effettiScrittaSelect.value);
  formData.append("effetto_sfondo", effettiSfondoSelect.value);

  const logoFile = document.getElementById("logoFile").files[0];
  if(logoFile) formData.append("logo", logoFile);

  try {
    const res = await fetch("https://matrimonioapp.ew.r.appspot.com/admin/save_theme?admin=default", {method:"POST", body:formData});
    const data = await res.json();
    alert(data.success ? "Tema salvato!" : "Errore salvataggio tema");
  } catch(e){ console.error(e); }
});

// ----------- INIT -----------
window.onload = async () => { 
  await caricaFonts();
  await caricaEffetti();
  aggiornaAnteprima();
};
</script>

<footer>
  <a href="index.html" class="pulsante">Menu</a>
</footer>
</body>
</html>
