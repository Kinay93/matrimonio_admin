<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Tema Matrimonio</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<header>
    <h1>Amministrazione Tema</h1>
    <button id="salvaTemaBtn">Salva Tema</button>
</header>
<main>
    <div class="two-columns">
        <!-- FORM -->
        <div class="form-box">
            <h2>Configurazione Tema</h2>
            <label>Colore Sfondo Primario:</label>
            <input type="color" id="bgColor" name="bgColor">
            <label>Colore Sfondo Secondario:</label>
            <input type="color" id="bgColorSecondario" name="bgColorSecondario">
            <label>Colore Testo:</label>
            <input type="color" id="textColor" name="textColor">
            <label>Colore Header:</label>
            <input type="color" id="headerColor" name="headerColor">
            <label>Testo Header:</label>
            <input type="text" id="headerText" name="headerText">

            <label>Font:</label>
            <select id="fontSelect"></select>

            <label>Effetto Scritta:</label>
            <select id="effettoScrittaSelect"></select>

            <label>Effetto Sfondo:</label>
            <select id="effettoSfondoSelect"></select>

            <label>Logo:</label>
            <input type="file" id="logoInput">
            <img id="logoPreview" class="logo-preview" src="" alt="Logo Preview">
        </div>

        <!-- PREVIEW -->
        <div class="preview-box">
            <h2>Anteprima</h2>
            <div id="previewArea" style="padding:2rem; border-radius:8px;">
                <h3 id="previewHeader">Header di esempio</h3>
                <p id="previewText">Testo di esempio</p>
            </div>
        </div>
    </div>
</main>

<script>
const backendURL = "https://matrimonioapp.ew.r.appspot.com";

const bgColorInput = document.getElementById("bgColor");
const bgColorSecondarioInput = document.getElementById("bgColorSecondario");
const textColorInput = document.getElementById("textColor");
const headerColorInput = document.getElementById("headerColor");
const headerTextInput = document.getElementById("headerText");
const fontSelect = document.getElementById("fontSelect");
const effettoScrittaSelect = document.getElementById("effettoScrittaSelect");
const effettoSfondoSelect = document.getElementById("effettoSfondoSelect");
const logoInput = document.getElementById("logoInput");
const logoPreview = document.getElementById("logoPreview");

const previewArea = document.getElementById("previewArea");
const previewHeader = document.getElementById("previewHeader");
const previewText = document.getElementById("previewText");

// ----------------------
// Carica Font dal backend
// ----------------------
async function caricaFonts() {
    try {
        const res = await fetch(`${backendURL}/admin/get_fonts`);
        if(!res.ok) throw new Error("Errore fetch fonts");
        const data = await res.json();
        const fonts = data.fonts || [];

        fontSelect.innerHTML = "";
        fonts.forEach(f => {
            const option = document.createElement("option");
            option.value = f.css_family;
            option.textContent = f.name;
            fontSelect.appendChild(option);
        });
    } catch(e) {
        console.error("Errore caricamento fonts:", e);
    }
}

// ----------------------
// Carica Effetti dal backend
// ----------------------
async function caricaEffetti() {
    try {
        const res = await fetch(`${backendURL}/admin/get_effetti`);
        if(!res.ok) throw new Error("Errore fetch effetti");
        const data = await res.json();

        effettoScrittaSelect.innerHTML = "";
        (data.scritta || []).forEach(eff => {
            const option = document.createElement("option");
            option.value = eff.id;
            option.textContent = eff.name;
            effettoScrittaSelect.appendChild(option);
        });

        effettoSfondoSelect.innerHTML = "";
        (data.sfondo || []).forEach(eff => {
            const option = document.createElement("option");
            option.value = eff.id;
            option.textContent = eff.name;
            effettoSfondoSelect.appendChild(option);
        });
    } catch(e) {
        console.error("Errore caricamento effetti:", e);
    }
}

// ----------------------
// Carica Tema corrente
// ----------------------
async function caricaTema() {
    try {
        const res = await fetch(`${backendURL}/admin/get_theme?admin=default`);
        if(!res.ok) throw new Error("Errore fetch tema");
        const data = await res.json();
        if(!data.success) return;

        const c = data.config;
        bgColorInput.value = c.bg_color || "#ffffff";
        bgColorSecondarioInput.value = c.bg_color_secondario || "#ffffff";
        textColorInput.value = c.text_color || "#000000";
        headerColorInput.value = c.header_color || "#007BFF";
        headerTextInput.value = c.header_text || "Header di esempio";
        fontSelect.value = c.font_family || "Arial, sans-serif";
        effettoScrittaSelect.value = c.effetto_scritta || "";
        effettoSfondoSelect.value = c.effetto_sfondo || "";
        if(c.logo_url) {
            logoPreview.src = c.logo_url;
        }

        aggiornaAnteprima();
    } catch(e) {
        console.error("Errore caricamento tema:", e);
    }
}

// ----------------------
// Aggiorna Anteprima
// ----------------------
function aggiornaAnteprima() {
    previewArea.style.background = "none";
    previewArea.style.fontFamily = fontSelect.value;
    previewHeader.textContent = headerTextInput.value;
    previewHeader.style.color = textColorInput.value;
    previewText.style.color = textColorInput.value;

    // Applica effetto scritta
    const effettoScritta = effettoScrittaSelect.value;
    if(effettoScritta) previewText.className = effettoScritta;

    // Applica effetto sfondo con due colori
    const effettoSfondo = effettoSfondoSelect.value;
    if(effettoSfondo) {
        previewArea.className = "";
        previewArea.classList.add(effettoSfondo);
        previewArea.style.setProperty('--bgColor', bgColorInput.value);
        previewArea.style.setProperty('--bgColor2', bgColorSecondarioInput.value);
    } else {
        previewArea.style.backgroundColor = bgColorInput.value;
    }
}

// ----------------------
// Eventi input
// ----------------------
[bgColorInput, bgColorSecondarioInput, textColorInput, headerColorInput, headerTextInput, fontSelect, effettoScrittaSelect, effettoSfondoSelect].forEach(el => {
    el.addEventListener("input", aggiornaAnteprima);
});

logoInput.addEventListener("change", () => {
    const file = logoInput.files[0];
    if(file) {
        const reader = new FileReader();
        reader.onload = e => { logoPreview.src = e.target.result; };
        reader.readAsDataURL(file);
    }
});

// ----------------------
// Salva Tema
// ----------------------
document.getElementById("salvaTemaBtn").addEventListener("click", async () => {
    const formData = new FormData();
    formData.append("bg_color", bgColorInput.value);
    formData.append("bg_color_secondario", bgColorSecondarioInput.value);
    formData.append("text_color", textColorInput.value);
    formData.append("header_color", headerColorInput.value);
    formData.append("header_text", headerTextInput.value);
    formData.append("font_family", fontSelect.value);
    formData.append("effetto_scritta", effettoScrittaSelect.value);
    formData.append("effetto_sfondo", effettoSfondoSelect.value);
    if(logoInput.files[0]) formData.append("logo", logoInput.files[0]);

    try {
        const res = await fetch(`${backendURL}/admin/save_theme?admin=default`, {
            method: "POST",
            body: formData
        });
        if(!res.ok) throw new Error("Errore salvataggio tema");
        const data = await res.json();
        alert("Tema salvato correttamente!");
    } catch(e) {
        console.error("Errore salvataggio tema:", e);
    }
});

// ----------------------
// INIT
// ----------------------
async function init() {
    await caricaFonts();
    await caricaEffetti();
    await caricaTema();
}

init();
</script>
</body>
</html>
