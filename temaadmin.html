<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Admin Matrimonio</title>
<style>
  :root {
    --bg-color: #ffffff;
    --bg-color-rgb: 255,255,255;
    --bg-color-secondario: #eeeeee;
    --bg-color-secondario-rgb: 238,238,238;
    --text-color: #000000;
    --header-color: #007BFF;
    --header-text: #ffffff;
  }

  body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
  }

  .form-box, .preview-box {
    padding: 1rem;
    margin: 1rem;
    border: 1px solid #ccc;
    border-radius: 5px;
  }

  .preview-box {
    min-height: 200px;
    background-color: var(--bg-color);
    color: var(--text-color);
    font-family: var(--font-family, Arial);
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
  }

  h2 {
    margin-bottom: 0.5rem;
  }

  .overlay {
    position: absolute;
    top:0; left:0; right:0; bottom:0;
    pointer-events: none;
  }
</style>
</head>
<body>
<div class="form-box">
  <h2>Impostazioni Tema</h2>
  
  <label>Colore Sfondo Primario:</label>
  <input type="color" id="bgColorInput" value="#ffffff"><br><br>

  <label>Colore Sfondo Secondario:</label>
  <input type="color" id="bgColorSecondarioInput" value="#eeeeee"><br><br>

  <label>Colore Testo:</label>
  <input type="color" id="textColorInput" value="#000000"><br><br>

  <label>Font:</label>
  <select id="fontsSelect"></select><br><br>

  <label>Effetto Scritta:</label>
  <select id="effettiScrittaSelect"></select><br><br>

  <label>Effetto Sfondo:</label>
  <select id="effettiSfondoSelect"></select><br><br>

  <button id="saveBtn">Salva Tema</button>
</div>

<div class="preview-box" id="previewBox">
  Anteprima Testo
</div>

<script>
  async function checkAuth() {
    const token = localStorage.getItem("auth_token");
    if(!token){
        window.location.href = "/login_page";
        return;
    }

    try {
        const res = await fetch("/me", {
            headers: { "Authorization": "Bearer " + token }
        });
        const data = await res.json();
        if(!data.success){
            localStorage.removeItem("auth_token");
            window.location.href = "/login_page";
        }
        // Se è valido, puoi mostrare dati dell’admin
        console.log("Utente autenticato:", data.email);
    } catch(err){
        localStorage.removeItem("auth_token");
        window.location.href = "/login_page";
    }
}

checkAuth();
const previewBox = document.getElementById('previewBox');
const bgColorInput = document.getElementById('bgColorInput');
const bgColorSecondarioInput = document.getElementById('bgColorSecondarioInput');
const textColorInput = document.getElementById('textColorInput');
const fontsSelect = document.getElementById('fontsSelect');
const effettiScrittaSelect = document.getElementById('effettiScrittaSelect');
const effettiSfondoSelect = document.getElementById('effettiSfondoSelect');
const saveBtn = document.getElementById('saveBtn');

let effettiScritta = [];
let effettiSfondo = [];
let fonts = [];

// --- Helper: HEX to RGB
function hexToRgb(hex) {
  hex = hex.replace('#','');
  if(hex.length === 3) hex = hex.split('').map(c => c+c).join('');
  const bigint = parseInt(hex,16);
  const r = (bigint >> 16) & 255;
  const g = (bigint >> 8) & 255;
  const b = bigint & 255;
  return `${r}, ${g}, ${b}`;
}

// --- Carica font dal backend
async function caricaFonts() {
  try {
    const res = await fetch('https://matrimonioapp.ew.r.appspot.com/admin/get_fonts', {mode: 'cors'});
    if(!res.ok) throw new Error("Errore fetch fonts");
    const data = await res.json();
    fonts = data.fonts;
    fontsSelect.innerHTML = '';
    fonts.forEach(f => {
      const option = document.createElement('option');
      option.value = f.css_family;
      option.textContent = f.name;
      fontsSelect.appendChild(option);
    });
  } catch(e) { console.error("Errore caricamento fonts:", e); }
}

// --- Carica effetti scritta
async function caricaEffettiScritta() {
  try {
    const res = await fetch('https://matrimonioapp.ew.r.appspot.com/admin/get_effetti', {mode: 'cors'});
    if(!res.ok) throw new Error("Errore fetch effetti");
    const data = await res.json();
    effettiScritta = data.scritta;
    effettiScrittaSelect.innerHTML = '';
    effettiScritta.forEach(e => {
      const option = document.createElement('option');
      option.value = e.id;
      option.textContent = e.name;
      effettiScrittaSelect.appendChild(option);
    });
  } catch(e) { console.error("Errore caricamento effetti scritta:", e); }
}

// --- Carica effetti sfondo
async function caricaEffettiSfondo() {
  try {
    const res = await fetch('https://matrimonioapp.ew.r.appspot.com/admin/get_effetti', {mode: 'cors'});
    if(!res.ok) throw new Error("Errore fetch effetti");
    const data = await res.json();
    effettiSfondo = data.sfondo;
    effettiSfondoSelect.innerHTML = '';
    effettiSfondo.forEach(e => {
      const option = document.createElement('option');
      option.value = e.id;
      option.textContent = e.name;
      effettiSfondoSelect.appendChild(option);
    });
  } catch(e) { console.error("Errore caricamento effetti sfondo:", e); }
}

// --- Aggiorna anteprima con overlay e fix parsing CSS
function aggiornaAnteprima() {
  // Reset completo degli stili inline
  previewBox.style.cssText = '';
  
  // Font e colore testo
  previewBox.style.fontFamily = fontsSelect.value;
  previewBox.style.color = textColorInput.value;

  // Variabili CSS
  const bgRgb = hexToRgb(bgColorInput.value);
  const bgSecondarioRgb = hexToRgb(bgColorSecondarioInput.value);
  previewBox.style.setProperty('--bg-color', bgColorInput.value);
  previewBox.style.setProperty('--bg-color-rgb', bgRgb);
  previewBox.style.setProperty('--bg-color-secondario', bgColorSecondarioInput.value);
  previewBox.style.setProperty('--bg-color-secondario-rgb', bgSecondarioRgb);

  // Effetto scritta
  const effScritta = effettiScritta.find(e => e.id === effettiScrittaSelect.value);
  if(effScritta && effScritta.css) {
    let scrittaCss = effScritta.css.replace(/var\(--text-color\)/g, textColorInput.value);
    scrittaCss.split(';').forEach(rule => {
      if(rule.trim()){
        let [prop, ...rest] = rule.split(':');
        let val = rest.join(':');
        if(prop && val) previewBox.style.setProperty(prop.trim(), val.trim());
      }
    });
  }

  // Effetto sfondo
  const effSfondo = effettiSfondo.find(e => e.id === effettiSfondoSelect.value);
  let overlayColor = `rgba(${bgRgb}, 0.3)`;
  if(effSfondo && effSfondo.css) {
    let sfondoCss = effSfondo.css
      .replace(/var\(--bg-color\)/g, bgColorInput.value)
      .replace(/var\(--bg-color-rgb\)/g, bgRgb)
      .replace(/var\(--bg-color-secondario\)/g, bgColorSecondarioInput.value)
      .replace(/var\(--bg-color-secondario-rgb\)/g, bgSecondarioRgb);

    sfondoCss.split(';').forEach(rule => {
      if(rule.trim()){
        let [prop, ...rest] = rule.split(':'); // fix parsing CSS con ":" negli URL
        let val = rest.join(':');
        if(prop && val) previewBox.style.setProperty(prop.trim(), val.trim());
      }
    });

    // Overlay automatico se c'è immagine
    const bgImageMatch = sfondoCss.match(/url\(([^)]+)\)/);
    if(bgImageMatch) {
      previewBox.style.position = 'relative';
      if(!previewBox.querySelector('.overlay')) {
        const overlay = document.createElement('div');
        overlay.className = 'overlay';
        overlay.style.backgroundColor = overlayColor;
        previewBox.appendChild(overlay);
      } else {
        previewBox.querySelector('.overlay').style.backgroundColor = overlayColor;
      }
    } else {
      const existingOverlay = previewBox.querySelector('.overlay');
      if(existingOverlay) existingOverlay.remove();
    }
  }
}

// --- Event listeners
[bgColorInput, bgColorSecondarioInput, textColorInput, fontsSelect, effettiScrittaSelect, effettiSfondoSelect]
  .forEach(el => el.addEventListener('input', aggiornaAnteprima));

saveBtn.addEventListener('click', async () => {
  const formData = new FormData();
  formData.append('bg_color', bgColorInput.value);
  formData.append('bg_color_secondario', bgColorSecondarioInput.value);
  formData.append('text_color', textColorInput.value);
  formData.append('font_family', fontsSelect.value);
  formData.append('effetto_scritta', effettiScrittaSelect.value);
  formData.append('effetto_sfondo', effettiSfondoSelect.value);

  try {
    const res = await fetch('https://matrimonioapp.ew.r.appspot.com/admin/save_theme?admin=default', {
      method: 'POST',
      body: formData
    });
    const data = await res.json();
    if(data.success) alert('Tema salvato!');
    else alert('Errore salvataggio tema');
  } catch(e) { console.error('Errore save theme:', e); }
});

// --- Init
async function init() {
  await caricaFonts();
  await caricaEffettiScritta();
  await caricaEffettiSfondo();
  aggiornaAnteprima();
}

init();
</script>
</body>
</html>
