<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Admin Matrimonio</title>
<style>
  :root {
    --bg-color: #ffffff;
    --bg-color-secondario: #eeeeee;
    --text-color: #000000;
    --header-color: #007BFF;
    --header-text: #ffffff;
  }

  body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
  }

  .form-box, .preview-box {
    padding: 1rem;
    margin: 1rem;
    border: 1px solid #ccc;
    border-radius: 5px;
  }

  .preview-box {
    min-height: 200px;
    background-color: var(--bg-color);
    color: var(--text-color);
    font-family: var(--font-family, Arial);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  h2 {
    margin-bottom: 0.5rem;
  }
</style>
</head>
<body>
<div class="form-box">
  <h2>Impostazioni Tema</h2>
  
  <label>Colore Sfondo Primario:</label>
  <input type="color" id="bgColorInput" value="#ffffff"><br><br>

  <label>Colore Sfondo Secondario:</label>
  <input type="color" id="bgColorSecondarioInput" value="#eeeeee"><br><br>

  <label>Colore Testo:</label>
  <input type="color" id="textColorInput" value="#000000"><br><br>

  <label>Font:</label>
  <select id="fontsSelect"></select><br><br>

  <label>Effetto Scritta:</label>
  <select id="effettiScrittaSelect"></select><br><br>

  <label>Effetto Sfondo:</label>
  <select id="effettiSfondoSelect"></select><br><br>

  <button id="saveBtn">Salva Tema</button>
</div>

<div class="preview-box" id="previewBox">
  Anteprima Testo
</div>

<script>
const previewBox = document.getElementById('previewBox');
const bgColorInput = document.getElementById('bgColorInput');
const bgColorSecondarioInput = document.getElementById('bgColorSecondarioInput');
const textColorInput = document.getElementById('textColorInput');
const fontsSelect = document.getElementById('fontsSelect');
const effettiScrittaSelect = document.getElementById('effettiScrittaSelect');
const effettiSfondoSelect = document.getElementById('effettiSfondoSelect');
const saveBtn = document.getElementById('saveBtn');

let effettiScritta = [];
let effettiSfondo = [];
let fonts = [];

// --- Carica font dal backend
async function caricaFonts() {
  try {
    const res = await fetch('https://matrimonioapp.ew.r.appspot.com/admin/get_fonts', {mode: 'cors'});
    if(!res.ok) throw new Error("Errore fetch fonts");
    const data = await res.json();
    fonts = data.fonts;
    fontsSelect.innerHTML = '';
    fonts.forEach(f => {
      const option = document.createElement('option');
      option.value = f.css_family;
      option.textContent = f.name;
      fontsSelect.appendChild(option);
    });
  } catch(e) { console.error("Errore caricamento fonts:", e); }
}

// --- Carica effetti scritta
async function caricaEffettiScritta() {
  try {
    const res = await fetch('https://matrimonioapp.ew.r.appspot.com/admin/get_effetti', {mode: 'cors'});
    if(!res.ok) throw new Error("Errore fetch effetti");
    const data = await res.json();
    effettiScritta = data.scritta;
    effettiScrittaSelect.innerHTML = '';
    effettiScritta.forEach(e => {
      const option = document.createElement('option');
      option.value = e.id;
      option.textContent = e.name;
      effettiScrittaSelect.appendChild(option);
    });
  } catch(e) { console.error("Errore caricamento effetti scritta:", e); }
}

// --- Carica effetti sfondo
async function caricaEffettiSfondo() {
  try {
    const res = await fetch('https://matrimonioapp.ew.r.appspot.com/admin/get_effetti', {mode: 'cors'});
    if(!res.ok) throw new Error("Errore fetch effetti");
    const data = await res.json();
    effettiSfondo = data.sfondo;
    effettiSfondoSelect.innerHTML = '';
    effettiSfondo.forEach(e => {
      const option = document.createElement('option');
      option.value = e.id;
      option.textContent = e.name;
      effettiSfondoSelect.appendChild(option);
    });
  } catch(e) { console.error("Errore caricamento effetti sfondo:", e); }
}

// --- Aggiorna anteprima
function aggiornaAnteprima() {
  // Font
  previewBox.style.fontFamily = fontsSelect.value;

  // Colore testo
  previewBox.style.color = textColorInput.value;

  // Effetto scritta
  const effScritta = effettiScritta.find(e => e.id === effettiScrittaSelect.value);
  previewBox.style.cssText = previewBox.style.cssText; // reset inline
  if(effScritta && effScritta.css) {
    previewBox.style.cssText += effScritta.css.replace(/var\(--text-color\)/g, textColorInput.value);
  }

  // Colore sfondo
  previewBox.style.setProperty('--bg-color', bgColorInput.value);
  previewBox.style.setProperty('--bg-color-secondario', bgColorSecondarioInput.value);

  // Effetto sfondo
  const effSfondo = effettiSfondo.find(e => e.id === effettiSfondoSelect.value);
  if(effSfondo && effSfondo.css) {
    previewBox.style.cssText += effSfondo.css
      .replace(/var\(--bg-color\)/g, bgColorInput.value)
      .replace(/var\(--bg-color-secondario\)/g, bgColorSecondarioInput.value);
  }
}

// --- Event listeners
[bgColorInput, bgColorSecondarioInput, textColorInput, fontsSelect, effettiScrittaSelect, effettiSfondoSelect]
  .forEach(el => el.addEventListener('input', aggiornaAnteprima));
  
saveBtn.addEventListener('click', async () => {
  const formData = new FormData();
  formData.append('bg_color', bgColorInput.value);
  formData.append('bg_color_secondario', bgColorSecondarioInput.value);
  formData.append('text_color', textColorInput.value);
  formData.append('font_family', fontsSelect.value);
  formData.append('effetto_scritta', effettiScrittaSelect.value);
  formData.append('effetto_sfondo', effettiSfondoSelect.value);

  try {
    const res = await fetch('https://matrimonioapp.ew.r.appspot.com/admin/save_theme?admin=default', {
      method: 'POST',
      body: formData
    });
    const data = await res.json();
    if(data.success) alert('Tema salvato!');
    else alert('Errore salvataggio tema');
  } catch(e) { console.error('Errore save theme:', e); }
});

// --- Init
async function init() {
  await caricaFonts();
  await caricaEffettiScritta();
  await caricaEffettiSfondo();
  aggiornaAnteprima();
}

init();
</script>
</body>
</html>
