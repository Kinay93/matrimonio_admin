<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Amministrazione Matrimonio</title>
<link rel="stylesheet" href="style.css">
<style>
body { font-family: Arial, sans-serif; margin:0; padding:0; background:#fafafa; }

/* Navbar con dropdown */
.navbar {
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:10px 20px;
  background:#2EC4B6;
  color:white;
  flex-wrap:wrap;
}
.navbar h1 { font-size:1.3rem; margin:0; }
.navbar .user-menu { position:relative; display:inline-block; }
.user-btn {
  display:flex; align-items:center; gap:8px;
  background:white; border:none; border-radius:20px;
  padding:6px 12px; cursor:pointer; font-weight:bold; color:#2EC4B6;
}
.user-btn img { width:28px; height:28px; border-radius:50%; }
.dropdown-menu {
  display:none; position:absolute; right:0; top:45px; background:white;
  border:1px solid #ddd; border-radius:8px; min-width:150px; box-shadow:0 4px 10px rgba(0,0,0,0.15); z-index:1000;
}
.dropdown-menu a {
  display:block; padding:10px; text-decoration:none; color:#333;
}
.dropdown-menu a:hover { background:#f0f0f0; }

/* Bottone Nuovo Evento */
#nuovo-matrimonio { padding:8px 14px; border:none; border-radius:6px; cursor:pointer; background:#007bff; color:white; transition:0.3s; }
#nuovo-matrimonio:hover { background:#0056b3; transform: scale(1.05); }

/* Container e grid */
.container { padding:20px; }
.grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(150px,1fr)); gap:20px; }
@media(min-width:1024px){.grid{grid-template-columns:repeat(5,1fr);}}

/* cards */
.evento-card { background:white; border-radius:12px; box-shadow:0 2px 5px rgba(0,0,0,0.1);
  padding:15px; text-align:center; transition: transform 0.2s ease, box-shadow 0.3s ease, opacity 0.5s ease;
  opacity:0; transform:translateY(20px);}
.evento-card.visible{opacity:1; transform:translateY(0);}
.evento-card:hover{transform:translateY(-5px); box-shadow:0 6px 15px rgba(0,0,0,0.15);}
.evento-card h3 { margin:0 0 10px; font-size:1rem; }
.evento-img { width:80px; height:80px; border-radius:50%; background:#ddd; margin:0 auto 10px; overflow:hidden; }
.evento-img img { width:100%; height:100%; object-fit:cover; display:block; transition:transform 0.3s ease; }
.evento-card:hover .evento-img img { transform:scale(1.1); }
.evento-card button { display:block; width:100%; margin:5px 0; padding:6px; border:none; border-radius:6px;
  cursor:pointer; font-size:0.9rem; transition:0.3s; }
.btn-genera { background:#28a745; color:white; }
.btn-genera:hover { background:#218838; transform:scale(1.03); }
.btn-vedi { background:#6c757d; color:white; }
.btn-vedi:hover { background:#5a6268; transform:scale(1.03); }
</style>
<script src="navbar.js" defer></script>
<script src="script.js" defer></script>
</head>
<body>

<!-- Navbar -->
<div class="navbar" id="navbar">
  <h1>Amministrazione Matrimonio</h1>
  <div class="user-menu">
    <button id="userBtn" class="user-btn">
      <img src="https://img.icons8.com/ios-filled/50/user-male-circle.png" alt="Avatar">
      <span>Admin</span>
    </button>
    <div id="dropdownMenu" class="dropdown-menu">
      <a href="profilo.html">Profilo</a>
      <a href="temaadmin.html">Temi</a>
      <a href="#" id="logoutBtn">Logout</a>
    </div>
  </div>
  <button id="nuovo-matrimonio">Nuovo Evento</button>
</div>

<div class="container">
  <div class="grid" id="Eventi-grid">
    <!-- Eventi generati dinamicamente -->
  </div>
</div>
<script>
// --- Controllo autenticazione
async function checkAuth() {
  const token = localStorage.getItem("auth_token");
  if(!token) window.location.href = "login.html";
  try {
    const res = await fetch("https://matrimonioapp.ew.r.appspot.com/me", {
      headers: { "Authorization": "Bearer " + token }
    });
    const data = await res.json();
    if(!data.success){
      localStorage.removeItem("auth_token");
      localStorage.removeItem("admin_username");
      window.location.href = "login.html";
    } else {
      if(data.username) localStorage.setItem("admin_username", data.username);
    }
  } catch(err){
    console.error("Errore checkAuth:", err);
    localStorage.removeItem("auth_token");
    localStorage.removeItem("admin_username");
    window.location.href = "login.html";
  }
}

// --- Dropdown utente
function setupDropdown() {
  const userBtn = document.getElementById('userBtn');
  const dropdownMenu = document.getElementById('dropdownMenu');

  userBtn.addEventListener('click', e => {
    e.stopPropagation();
    const isOpen = dropdownMenu.style.display === 'block';
    dropdownMenu.style.display = isOpen ? 'none' : 'block';
  });

  window.addEventListener('click', e => {
    if(!userBtn.contains(e.target) && !dropdownMenu.contains(e.target)) {
      dropdownMenu.style.display = 'none';
    }
  });

  document.getElementById('logoutBtn').addEventListener('click', ()=>{
    localStorage.removeItem("auth_token");
    localStorage.removeItem("admin_username");
    window.location.href = "login.html";
  });
}

// --- Nuovo evento
document.getElementById('nuovo-matrimonio').addEventListener('click', ()=> {
  window.location.href = 'nuovo_evento.html';
});

// --- Funzione per sanificare nomi (usata per qrcode/eventi in URL)
function sanitizeName(s){
  if(!s) return "";
  return String(s).trim().replace(/\s+/g,'_').replace(/[^a-zA-Z0-9_]/g,'');
}

// --- Genera QR
async function generaQRCode(eventoNome, btn, btnVediRef) {
  try {
    btn.disabled = true; // evita doppi click
    const token = localStorage.getItem("auth_token");
    const admin = localStorage.getItem('admin_username') || 'Admin';

    const eventoS = sanitizeName(eventoNome);
    const adminS = sanitizeName(admin);

    console.log("generaQRCode -> evento:", eventoS, "admin:", adminS);

    const res = await fetch(`https://matrimonioapp.ew.r.appspot.com/admin/genera_qrcode?evento=${encodeURIComponent(eventoS)}&admin=${encodeURIComponent(adminS)}`, {
      headers: { "Authorization": `Bearer ${token}` }
    });
    const data = await res.json();
    if(data.success){
      // se il server ritorna qr_url lo usiamo per il pulsante Vedi
      if(data.qr_url){
        // memorizza l'url sul bottone Vedi
        btnVediRef.dataset.qrUrl = data.qr_url;
      }
      btn.disabled = true;
      btnVediRef.disabled = false;
      // aggiorna stato visibile (se vuoi mantenere stato lato client)
      btnVediRef.classList.remove('disabled');
      alert("QR generato!");
    } else {
      btn.disabled = false;
      alert("Errore generazione QR: " + (data.error||"imprevisto"));
    }
  } catch(err){
    console.error(err);
    btn.disabled = false;
    alert("Errore generazione QR.");
  }
}

// --- Vedi QR
function vediQRCode(eventoNome, btnVediRef) {
  const admin = localStorage.getItem('admin_username') || 'Admin';
  const eventoS = sanitizeName(eventoNome);
  const adminS = sanitizeName(admin);

  // se il bottone ha qrUrl (pubblico) lo apriamo, altrimenti fallback all'endpoint di servizio
  const publicUrl = btnVediRef && btnVediRef.dataset && btnVediRef.dataset.qrUrl;
  if(publicUrl){
    window.open(publicUrl, "_blank");
    return;
  }

  const url = `https://matrimonioapp.ew.r.appspot.com/admin/get_qrcode?evento=${encodeURIComponent(eventoS)}&admin=${encodeURIComponent(adminS)}`;
  window.open(url, "_blank");
}

// --- Caricamento eventi con debug dettagliato
async function caricaEventi() {
  try {
    const token = localStorage.getItem("auth_token");
    const username = localStorage.getItem("admin_username") || "Admin";
    console.log("Fetch eventi per admin:", username);

    const res = await fetch(`https://matrimonioapp.ew.r.appspot.com/admin/get_eventi?admin=${encodeURIComponent(username)}`, {
      headers: { "Authorization": "Bearer " + token }
    });
    const data = await res.json();
    console.log("Response eventi:", data);

    const grid = document.getElementById('Eventi-grid');
    grid.innerHTML = '';

    if (!data.success || !Array.isArray(data.eventi)) {
      console.warn("Nessun evento trovato o formato errato", data);
      return;
    }

    data.eventi.forEach((evento,index)=>{
      if(!evento || !evento.nome) return;

      const card = document.createElement('div');
      card.className = 'evento-card';

      // --- Titolo evento
      const title = document.createElement('h3');
      title.textContent = evento.nome;
      card.appendChild(title);

      // --- Foto evento
      const imgContainer = document.createElement('div');
      imgContainer.className = 'evento-img';
      const img = document.createElement('img');

      // se foto_url è un percorso relativo (non pubblico) prova a trasformarlo in URL pubblico,
      // altrimenti usa direttamente quello restituito.
      let fotoSrc = evento.foto_url || '';
      if(fotoSrc && !/^https?:\/\//.test(fotoSrc)) {
        // prova a normalizzare: se il backend salva percorsi come "config/eventi/..." trasformali
        // nella public url del bucket (modifica se il tuo bucket ha un nome diverso)
        fotoSrc = `https://storage.googleapis.com/matrimonio_app_bucket/${encodeURI(fotoSrc)}`;
      }
      img.src = fotoSrc || 'https://via.placeholder.com/100';
      img.alt = evento.nome;
      imgContainer.appendChild(img);

      // --- Click per modifica evento, passa anche admin
      imgContainer.addEventListener('click', () => {
        const adminParam = localStorage.getItem('admin_username') || 'Admin';
        window.location.href = `modifica_evento.html?evento=${encodeURIComponent(evento.nome)}&admin=${encodeURIComponent(adminParam)}`;
      });
      card.appendChild(imgContainer);

      // --- Pulsante Genera QR
      const btnGenera = document.createElement('button');
      btnGenera.textContent = 'Genera QR';
      btnGenera.className = 'btn-genera';

      // --- Pulsante Vedi QR
      const btnVedi = document.createElement('button');
      btnVedi.textContent = 'Vedi QR';
      btnVedi.className = 'btn-vedi';

      // determino se già c'è il QR (gestisco vari possibili formati: booleano/string/qr_url)
      const hasQr = !!(evento.qr_generato === true || evento.qr_generato === 'true' || evento.qr_url);
      btnGenera.disabled = hasQr;
      btnVedi.disabled = !hasQr;

      // se c'è qr_url pubblico lo assegno al bottone Vedi per apertura diretta
      if(evento.qr_url && typeof evento.qr_url === 'string' && evento.qr_url.trim()){
        btnVedi.dataset.qrUrl = evento.qr_url;
      }

      // aggiungo listeners (con stopPropagation per non scatenare il click dell'immagine)
      btnGenera.addEventListener('click', e=>{
        e.stopPropagation();
        // disabilito subito per evitare doppio click; generaQRCode gestirà il riabilitare in caso di errore
        btnGenera.disabled = true;
        generaQRCode(evento.nome, btnGenera, btnVedi);
      });

      btnVedi.addEventListener('click', e=>{
        e.stopPropagation();
        vediQRCode(evento.nome, btnVedi);
      });

      // aggiungo i bottoni alla card
      card.appendChild(btnGenera);
      card.appendChild(btnVedi);

      // --- Aggiungi card alla grid
      grid.appendChild(card);
      setTimeout(()=>card.classList.add('visible'), index*100);
    });
  } catch(err) {
    console.error("Errore caricamento eventi:", err);
  }
}

// --- Onload
window.addEventListener('DOMContentLoaded', async ()=>{
  await checkAuth();
  document.querySelector('#userBtn span').textContent = localStorage.getItem('admin_username') || 'Admin';
  setupDropdown();
  await caricaEventi();
});
</script>
</body>
</html>
