<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Amministrazione Matrimonio</title>
<style>
.modal {
    position: fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background: rgba(0,0,0,0.8);
    display:none;
    justify-content:center;
    align-items:center;
    z-index:1000;
}
.modal img {
    max-width:80%;
    max-height:80%;
    border: 5px solid #fff;
}
.modal .close {
    position:absolute;
    top:10px;
    right:20px;
    font-size:30px;
    color:white;
    cursor:pointer;
}
.top-right {
    position:absolute;
    top:10px;
    right:10px;
}
</style>
</head>
<body>
<header>
    <h1>Amministrazione Matrimonio</h1>
    <button id="nuovo-matrimonio" class="top-right">Nuovo Matrimonio</button>
    <button id="settings" class="top-right" style="right:60px;">⚙️</button>
</header>

<main>
<section class="coppie-section">
    <h2>Le tue coppie</h2>
    <table id="coppie-table">
        <thead>
            <tr>
                <th>Coppia</th>
                <th>QR Code</th>
            </tr>
        </thead>
        <tbody>
            <!-- Righe dinamiche -->
        </tbody>
    </table>
</section>
</main>

<!-- Modal QR fullscreen -->
<div id="qrcode-modal" class="modal">
    <span class="close">&times;</span>
    <img id="qrcode-fullscreen" src="" alt="QR Code Coppia">
    <a id="download-qrcode" href="" download="qrcode.jpg">
        <button>Scarica QR</button>
    </a>
</div>

<script>
// Reindirizza a nuova coppia
document.getElementById('nuovo-matrimonio').addEventListener('click', () => {
    window.location.href = 'nuovacoppia.html';
});

// Carica coppie
async function caricaCoppie() {
    const res = await fetch('https://matrimonioapp.ew.r.appspot.com/admin/get_coppie_admin');
    const data = await res.json();
    const tbody = document.querySelector('#coppie-table tbody');
    tbody.innerHTML = '';

    data.coppie.forEach(coppia => {
        const tr = document.createElement('tr');

        const tdNome = document.createElement('td');
        const link = document.createElement('a');
        link.href = `modificacoppia.html?coppia=${coppia.nome}`;
        link.textContent = coppia.nome;
        tdNome.appendChild(link);

        const tdQR = document.createElement('td');
        const btnGenera = document.createElement('button');
        btnGenera.textContent = 'Genera QR';
        btnGenera.disabled = coppia.qr_generato;
        btnGenera.addEventListener('click', () => generaQRCode(coppia.nome, btnGenera));

        const btnVedi = document.createElement('button');
        btnVedi.textContent = 'Vedi QR';
        btnVedi.disabled = !coppia.qr_generato;
        btnVedi.addEventListener('click', () => vediQRCode(coppia.nome));

        tdQR.appendChild(btnGenera);
        tdQR.appendChild(btnVedi);

        tr.appendChild(tdNome);
        tr.appendChild(tdQR);
        tbody.appendChild(tr);
    });
}

// Genera QR
async function generaQRCode(coppiaNome, btnGenera) {
    const res = await fetch(`https://matrimonioapp.ew.r.appspot.com/admin/genera_qrcode?coppia=${encodeURIComponent(coppiaNome)}`);
    const data = await res.json();
    if (data.success) {
        btnGenera.disabled = true;
        vediQRCode(coppiaNome); // mostra subito popup
        caricaCoppie();
    } else {
        alert('Errore generazione QR');
    }
}

// Mostra QR in popup (fetch + blob)
async function vediQRCode(coppiaNome) {
    try {
        const res = await fetch(`https://matrimonioapp.ew.r.appspot.com/admin/get_qrcode?coppia=${encodeURIComponent(coppiaNome)}`);
        if (!res.ok) throw new Error('QR code non trovato');

        const blob = await res.blob();
        const url = URL.createObjectURL(blob);

        const modal = document.getElementById('qrcode-modal');
        const img = document.getElementById('qrcode-fullscreen');
        const downloadBtn = document.getElementById('download-qrcode');

        img.src = url;
        downloadBtn.href = url;

        modal.style.display = 'flex';

        // Chiudi il popup dopo il download
        downloadBtn.onclick = () => {
            modal.style.display = 'none';
            URL.revokeObjectURL(url); // libera memoria
        };
    } catch (e) {
        alert(e.message);
    }
}


// Chiudi modal
document.querySelector('#qrcode-modal .close').addEventListener('click', () => {
    document.getElementById('qrcode-modal').style.display = 'none';
});

window.onload = caricaCoppie;
</script>
</body>
</html>
