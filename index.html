<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Amministrazione Matrimonio</title>
<link rel="stylesheet" href="style.css">
<style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; }
    header { display:flex; align-items:center; padding:10px; position:relative; background:#f5f5f5; }
    header h1 { margin-left:10px; }
    header button { position:absolute; right:10px; }
    .container { padding:20px; }
    table { width:100%; border-collapse: collapse; }
    th, td { border:1px solid #ccc; padding:8px; text-align:left; }
    .top-bar { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
</style>
</head>
<body>

<header>
    <img id="admin-logo" src="" alt="Logo" style="height:40px; margin-right:10px;">
    <h1>Amministrazione Matrimonio</h1>
    <button id="temaAdmin">⚙️</button>
</header>

<div class="container">
    <div class="top-bar">
        <h2>Le tue coppie</h2>
        <button id="nuovo-matrimonio">Nuovo Matrimonio</button>
    </div>

    <table id="coppie-table">
        <thead>
            <tr>
                <th>Coppia</th>
                <th>QR Code</th>
            </tr>
        </thead>
        <tbody>
            <!-- Righe dinamiche -->
        </tbody>
    </table>
</div>

<!-- Modal QR fullscreen -->
<div id="qrcode-modal" class="modal" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:none; justify-content:center; align-items:center; z-index:1000;">
    <span class="close" style="position:absolute; top:10px; right:20px; font-size:30px; color:white; cursor:pointer;">&times;</span>
    <img id="qrcode-fullscreen" src="" alt="QR Code Coppia" style="max-width:80%; max-height:80%; border:5px solid #fff;">
    <a id="download-qrcode" href="" download="qrcode.jpg">
        <button>Scarica QR</button>
    </a>
</div>

<script src="script.js"></script>
<script>
window.onload = async () => { 
    await applicaTemaAdmin();
    caricaCoppie(); 
};

// Tasto nuovo matrimonio
document.getElementById('nuovo-matrimonio').addEventListener('click', () => {
    window.location.href = 'nuovacoppia.html';
});

// Tasto tema admin
document.getElementById('temaAdmin').addEventListener('click', () => {
    window.location.href = 'temaadmin.html';
});

// Carica coppie
async function caricaCoppie() {
    try {
        const res = await fetch('https://matrimonioapp.ew.r.appspot.com/admin/get_coppie_admin');
        const data = await res.json();
        const tbody = document.querySelector('#coppie-table tbody');
        tbody.innerHTML = '';

        data.coppie.forEach(coppia => {
            const tr = document.createElement('tr');

            const tdNome = document.createElement('td');
            const link = document.createElement('a');
            link.href = `modificacoppia.html?coppia=${encodeURIComponent(coppia.nome)}`;
            link.textContent = coppia.nome;
            tdNome.appendChild(link);

            const tdQR = document.createElement('td');
            const btnGenera = document.createElement('button');
            btnGenera.textContent = 'Genera QR';
            btnGenera.disabled = coppia.qr_generato;
            btnGenera.addEventListener('click', () => generaQRCode(coppia.nome, btnGenera));

            const btnVedi = document.createElement('button');
            btnVedi.textContent = 'Vedi QR';
            btnVedi.disabled = !coppia.qr_generato;
            btnVedi.addEventListener('click', () => vediQRCode(coppia.nome));

            tdQR.appendChild(btnGenera);
            tdQR.appendChild(btnVedi);

            tr.appendChild(tdNome);
            tr.appendChild(tdQR);
            tbody.appendChild(tr);
        });
    } catch(e) {
        alert("Errore caricamento coppie: " + e.message);
    }
}

// Genera QR
async function generaQRCode(coppiaNome, btnGenera) {
    const res = await fetch(`https://matrimonioapp.ew.r.appspot.com/admin/genera_qrcode?coppia=${encodeURIComponent(coppiaNome)}`);
    const data = await res.json();
    if (data.success) {
        btnGenera.disabled = true;
        vediQRCode(coppiaNome);
        caricaCoppie();
    } else alert('Errore generazione QR');
}

// Mostra QR
async function vediQRCode(coppiaNome) {
    try {
        const res = await fetch(`https://matrimonioapp.ew.r.appspot.com/admin/get_qrcode?coppia=${encodeURIComponent(coppiaNome)}`);
        if (!res.ok) throw new Error('QR non trovato');
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);

        const modal = document.getElementById('qrcode-modal');
        const img = document.getElementById('qrcode-fullscreen');
        const downloadBtn = document.getElementById('download-qrcode');

        img.src = url;
        modal.style.display = 'flex';

        downloadBtn.onclick = () => {
            const a = document.createElement('a');
            a.href = url;
            a.download = `${coppiaNome}_qrcode.jpg`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            modal.style.display = 'none';
        };
    } catch(e) { alert(e.message); }
}

// Chiudi modal
document.querySelector('#qrcode-modal .close').addEventListener('click', () => {
    document.getElementById('qrcode-modal').style.display = 'none';
});
</script>
</body>
</html>
