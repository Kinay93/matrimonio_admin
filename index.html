<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amministrazione Matrimonio</title>
    <!--link rel="stylesheet" href="style.css" -->
</head>
<body>
    <header>
        <h1>Amministrazione Matrimonio</h1>
        <button id="nuovo-matrimonio" class="top-right">Nuovo Matrimonio</button>
    </header>

    <main>
        <section class="coppie-section">
            <h2>Le tue coppie</h2>
            <table id="coppie-table">
                <thead>
                    <tr>
                        <th>Coppia</th>
                        <th>QR Code</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Le righe verranno caricate dinamicamente dal backend -->
                </tbody>
            </table>
        </section>
    </main>

    <!-- Modal QR fullscreen -->
    <div id="qrcode-modal" class="modal" style="display:none;">
        <span class="close">&times;</span>
        <img id="qrcode-fullscreen" src="" alt="QR Code Coppia">
        <a id="download-qrcode" href="" download="qrcode.jpg">
            <button>Scarica QR</button>
        </a>
    </div>

    <script>
        // Reindirizza a admin.html per creare nuova coppia
        document.getElementById('nuovo-matrimonio').addEventListener('click', () => {
            window.location.href = 'nuovacoppia.html';
        });

        async function caricaCoppie() {
            const res = await fetch('https://matrimonioapp.ew.r.appspot.com/admin/get_coppie_admin');
            const data = await res.json();
            const tbody = document.querySelector('#coppie-table tbody');
            tbody.innerHTML = '';

            data.coppie.forEach(coppia => {
                const tr = document.createElement('tr');

                // Nome coppia cliccabile
                const tdNome = document.createElement('td');
                const link = document.createElement('a');
                link.href = `modificacoppia.html?coppia=${coppia.nome}`;
                link.textContent = coppia.nome;
                tdNome.appendChild(link);

                // QR code
                const tdQR = document.createElement('td');
                const btnGenera = document.createElement('button');
                btnGenera.textContent = 'Genera QR';
                btnGenera.disabled = coppia.qr_generato; 
                btnGenera.addEventListener('click', () => generaQRCode(coppia.nome, btnGenera));

                const btnVedi = document.createElement('button');
                btnVedi.textContent = 'Vedi QR';
                btnVedi.disabled = !coppia.qr_generato;
                if (coppia.qr_url) {
                    btnVedi.addEventListener('click', () => mostraQRCode(coppia.qr_url));
                }

                tdQR.appendChild(btnGenera);
                tdQR.appendChild(btnVedi);

                tr.appendChild(tdNome);
                tr.appendChild(tdQR);
                tbody.appendChild(tr);
            });
        }

        async function generaQRCode(coppiaNome, btnGenera) {
            const res = await fetch(`https://matrimonioapp.ew.r.appspot.com/admin/genera_qrcode?coppia=${encodeURIComponent(coppiaNome)}`);
            const data = await res.json();
            if (data.success) {
                btnGenera.disabled = true;
                mostraQRCode(data.qr_url); // Mostra subito il QR
                caricaCoppie(); // aggiorna la tabella per abilitare Vedi QR
            } else {
                alert('Errore generazione QR');
            }
        }

        function mostraQRCode(qr_url) {
            const modal = document.getElementById('qrcode-modal');
            document.getElementById('qrcode-fullscreen').src = qr_url;
            document.getElementById('download-qrcode').href = qr_url;
            modal.style.display = 'flex';
        }

        // Chiudi modal
        document.querySelector('#qrcode-modal .close').addEventListener('click', () => {
            document.getElementById('qrcode-modal').style.display = 'none';
        });

        // Carica coppie al load
        window.onload = caricaCoppie;
    </script>
</body>
</html>
