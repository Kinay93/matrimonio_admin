<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Nuova Coppia</title>
    <!-- <link rel="stylesheet" href="style.css"> --> 
</head>
<body>
    <div class="container">
        <h1>Nuovo Matrimonio</h1>

        <label for="nomeCoppia">Nome della Coppia:</label>
        <input type="text" id="nomeCoppia" placeholder="Inserisci nome coppia">

        <label for="fotoCoppia">Foto della coppia:</label>
        <input type="file" id="fotoCoppia">

        <label for="colorSfondo">Colore sfondo:</label>
        <input type="color" id="colorSfondo" value="#ffffff">

        <label for="colorTesto">Colore testo:</label>
        <input type="color" id="colorTesto" value="#000000">

        <button id="creaCoppiaBtn">Crea coppia</button>

        <div id="msg"></div>
    </div>

    <script>
        document.getElementById("creaCoppiaBtn").addEventListener("click", async () => {
            const nome = document.getElementById("nomeCoppia").value.trim();
            const fotoFile = document.getElementById("fotoCoppia").files[0];
            const colorSfondo = document.getElementById("colorSfondo").value;
            const colorTesto = document.getElementById("colorTesto").value;

            if (!nome) {
                alert("Inserisci un nome per la coppia");
                return;
            }
            if (!fotoFile) {
                alert("Seleziona una foto della coppia");
                return;
            }

            // 1. Creare la coppia
            let response = await fetch('https://matrimonioapp.ew.r.appspot.com/upload?coppia=${nome}', {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({nome_coppia: nome})
            });
            let data = await response.json();
            if (!data.success) {
                document.getElementById("msg").innerText = "Errore: " + (data.error || "Imprevisto");
                return;
            }

            // 2. Caricare la foto
            const formData = new FormData();
            formData.append("foto", fotoFile);
            response = await fetch('https://matrimonioapp.ew.r.appspot.com/upload?coppia=${nome}', {
                method: "POST",
                body: formData
            });
            data = await response.json();
            if (!data.success) {
                document.getElementById("msg").innerText = "Errore upload foto: " + (data.error || "Imprevisto");
                return;
            }

            const fotoUrl = data.files[0].file_url;

            // 3. Aggiornare la coppia con colori e foto
            const aggiornaConfig = {
                nome_coppia: nome,
                titolo_index: nome,
                foto_url: fotoUrl,
                colori: {
                    sfondo: colorSfondo,
                    testo: colorTesto,
                    font: "Arial"
                }
            };

            response = await ("/admin/aggiorna_coppia", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify(aggiornaConfig)
            });
            data = await response.json();
            if (data.success) {
                document.getElementById("msg").innerText = "Coppia creata con successo!";
                setTimeout(() => {
                    window.location.href = "index.html";
                }, 1000);
            } else {
                document.getElementById("msg").innerText = "Errore aggiornamento: " + (data.error || "Imprevisto");
            }
        });
    </script>
</body>
</html>
