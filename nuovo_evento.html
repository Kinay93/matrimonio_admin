<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Nuovo Evento</title>
<link rel="stylesheet" href="style.css">
<style>
/* (il tuo CSS rimane praticamente invariato) */
body {
    margin: 0;
    font-family: sans-serif;
    display: flex;
    flex-direction: column;
    min-height: 100vh;
}
.container { display:flex; flex:1; height:100vh; overflow:hidden; }
.form-col { flex:1; padding:20px; overflow-y:auto; border-right:1px solid #ccc; box-sizing:border-box; }
.anteprima-col { flex:1; padding:20px; position:sticky; top:0; height:100vh; box-sizing:border-box; }
#anteprima { width:80%; height:80%; max-width:400px; max-height:400px; border-radius:12px; overflow:hidden;
    display:flex; align-items:center; justify-content:center; transition: background 200ms ease, color 200ms ease; }
#anteprimaFoto { width:150px; height:150px; border-radius:10px; object-fit:cover; background:#eee; }
#anteprimaTesto { position:absolute; top:12px; left:12px; font-size:24px; }
footer { position:fixed; bottom:0; left:0; right:0; display:flex; justify-content:space-around; padding:10px; background:rgba(255,255,255,0.9); box-shadow:0 -2px 5px rgba(0,0,0,0.1); }
footer a { text-decoration:none; background:#c235d4; color:white; padding:10px 20px; border-radius:20px; }
</style>

<!-- Carica la navbar dinamica (defer per eseguire prima del nostro script inline se possibile) -->
<script src="navbar.js" defer></script>
</head>
<body>
  <!-- Placeholder per navbar -->
  <div id="navbar-placeholder"></div>

  <header>
    <h1>Nuovo Evento</h1>
  </header>

<div class="container">
    <div class="form-col">
        <label>Nome evento:<input type="text" id="nomeEvento" placeholder="Nome evento"></label>
        <label>Foto evento:<input type="file" id="fotoEvento" accept="image/*"></label>

        <!-- hidden tipo (server richiede "tipo") -->
        <input type="hidden" id="tipoEvento" value="evento">

        <label>Colore sfondo primario:<input type="color" id="colorSfondo" value="#ffffff"></label>
        <label>Colore sfondo secondario:<input type="color" id="colorSfondoSecondario" value="#eeeeee"></label>
        <label>Colore testo:<input type="color" id="colorTesto" value="#000000"></label>
        <label>Font:<select id="fontScelto"></select></label>
        <label>Effetto sfondo:<select id="effettoSfondo"></select></label>
        <label>Effetto scritta:<select id="effettoScritta"></select></label>
        <button id="creaEventoBtn">Crea Evento</button>
        <div id="msg" style="margin-top:10px;font-weight:bold;"></div>
    </div>

    <div class="anteprima-col">
        <h3>Anteprima</h3>
        <div id="anteprima" style="background:linear-gradient(135deg,#ffffff,#eeeeee); position:relative;">
            <img id="anteprimaFoto" src="" alt="Foto Evento">
            <span id="anteprimaTesto">Titolo Evento</span>
        </div>
    </div>
</div>

<footer>
    <a href="index.html" id="home-btn">Menu</a>
</footer>

<script>
// --- Gestione login / token scaduto
function logout() {
  localStorage.removeItem("auth_token");
  localStorage.removeItem("admin_username");
  window.location.href = "login.html";
}

function avvisaLogout() {
  if (!document.getElementById("session-expired-msg")) {
    const div = document.createElement("div");
    div.id = "session-expired-msg";
    div.style.position = "fixed";
    div.style.top = "0";
    div.style.left = "0";
    div.style.right = "0";
    div.style.background = "red";
    div.style.color = "white";
    div.style.padding = "10px";
    div.style.textAlign = "center";
    div.style.zIndex = "9999";
    div.innerHTML = `
      ⚠️ Sessione scaduta. 
      <button id="logoutBtn" style="margin-left:10px;padding:5px 10px;">Torna al login</button>
    `;
    document.body.appendChild(div);
    document.getElementById("logoutBtn").addEventListener("click", logout);
  }
}

// --- Wrapper fetch che intercetta i 401
async function fetchConAuth(url, options={}) {
  const token = localStorage.getItem("auth_token");
  options.headers = options.headers || {};
  if (token) options.headers["Authorization"] = "Bearer " + token;

  const res = await fetch(url, options);
  if (res.status === 401) {
    avvisaLogout();
    throw new Error("Sessione scaduta (401)");
  }
  return res;
}

// --- checkAuth aggiornato
async function checkAuth() {
  try {
    const res = await fetchConAuth("https://matrimonioapp.ew.r.appspot.com/me");
    const data = await res.json();
    if (!data.success) {
      avvisaLogout();
    }
  } catch (err) {
    console.error("Errore autenticazione:", err);
    avvisaLogout();
  }
}

// --- Utils
function hexToRgb(hex) {
  hex = hex.replace('#','');
  if(hex.length === 3) hex = hex.split('').map(c => c+c).join('');
  const bigint = parseInt(hex,16);
  const r = (bigint >> 16) & 255;
  const g = (bigint >> 8) & 255;
  const b = bigint & 255;
  return `${r}, ${g}, ${b}`;
}

// --- Parametri URL
const params = new URLSearchParams(window.location.search);
const nomeEventoParam = params.get("evento");
const adminParam = params.get("admin") || localStorage.getItem("admin_username");

// --- Elementi DOM
const anteprimaDiv = document.getElementById("anteprima");
const anteprimaTesto = document.getElementById("anteprimaTesto");
const anteprimaFoto = document.getElementById("anteprimaFoto");

const inputSfondo = document.getElementById("sfondo");
const inputSfondoSecondario = document.getElementById("sfondoSecondario");
const inputTesto = document.getElementById("testo");
const selectFont = document.getElementById("font");
const selectEffettoSfondo = document.getElementById("effettoSfondo");
const selectEffettoScritta = document.getElementById("effettoScritta");

let effettiScritta = [];
let effettiSfondo = [];
let fonts = [];

// --- Carica fonts ed effetti
async function caricaFontsEdEffetti() {
  try {
    const resFonts = await fetchConAuth("https://matrimonioapp.ew.r.appspot.com/admin/get_fonts");
    const dataFonts = await resFonts.json();
    fonts = dataFonts.fonts || [];
    selectFont.innerHTML = "";
    fonts.forEach(f=>{
      const o=document.createElement("option");
      o.value=f.css_family || f;
      o.textContent=f.name || f;
      o.style.fontFamily = f.css_family || f;
      selectFont.appendChild(o);
    });

    const resEffetti = await fetchConAuth("https://matrimonioapp.ew.r.appspot.com/admin/get_effetti");
    const dataEffetti = await resEffetti.json();
    effettiSfondo = dataEffetti.sfondo || [];
    effettiScritta = dataEffetti.scritta || [];

    selectEffettoSfondo.innerHTML = '';
    effettiSfondo.forEach(f=>{
      const o=document.createElement("option");
      o.value=f.id || f;
      o.textContent=f.name || f;
      selectEffettoSfondo.appendChild(o);
    });

    selectEffettoScritta.innerHTML = '';
    effettiScritta.forEach(f=>{
      const o=document.createElement("option");
      o.value=f.id || f;
      o.textContent=f.name || f;
      selectEffettoScritta.appendChild(o);
    });
  } catch(e){ console.error(e); }
}

// --- Carica dati evento
async function caricaDatiEvento() {
  try {
    const res = await fetchConAuth(`https://matrimonioapp.ew.r.appspot.com/admin/get_evento?evento=${encodeURIComponent(nomeEventoParam)}&admin=${encodeURIComponent(adminParam)}`);
    const data = await res.json();
    if(data.error){ alert("Evento non trovato"); return; }

    document.getElementById("nomeEvento").value = data.titolo_index || "";
    if(data.foto_url){
      anteprimaFoto.innerHTML = `<img src="${data.foto_url}" alt="Foto Evento">`;
    }

    inputSfondo.value = data.sfondo || "#ffffff";
    inputSfondoSecondario.value = data.sfondo_secondario || "#eeeeee";
    inputTesto.value = data.testo || "#000000";
    selectFont.value = data.font || "Arial";
    selectEffettoSfondo.value = data.effetto_sfondo || "";
    selectEffettoScritta.value = data.effetto_scritta || "";

    anteprimaTesto.textContent = data.titolo_index || "Titolo Evento";
    aggiornaAnteprima();
  } catch(err){
    console.error("Errore caricamento dati evento:", err);
  }
}

// --- Aggiorna anteprima
function aggiornaAnteprima() {
  const primary = inputSfondo.value || "#ffffff";
  const secondary = inputSfondoSecondario.value || "#eeeeee";
  const textColor = inputTesto.value || "#000000";

  anteprimaDiv.style.background = `linear-gradient(135deg, ${primary}, ${secondary})`;
  anteprimaTesto.style.color = textColor;
  anteprimaTesto.style.fontFamily = selectFont.value || "Arial";

  // Reset stile inline prima di applicare effetti
  anteprimaDiv.removeAttribute("style");
  anteprimaDiv.style.background = `linear-gradient(135deg, ${primary}, ${secondary})`;
  anteprimaTesto.removeAttribute("style");
  anteprimaTesto.style.color = textColor;
  anteprimaTesto.style.fontFamily = selectFont.value || "Arial";

  const bgRgb = hexToRgb(primary);
  const bgSecondarioRgb = hexToRgb(secondary);

  // --- Effetto scritta inline
  const effScritta = effettiScritta.find(e => String(e.id) === String(selectEffettoScritta.value));
  if(effScritta && effScritta.css){
    effScritta.css.split(";").forEach(rule=>{
      if(rule.trim()){
        const [propRaw,...valParts] = rule.split(":");
        const prop = propRaw && propRaw.trim();
        const val = valParts.join(":") && valParts.join(":").trim();
        if(prop && val){
          anteprimaTesto.style.setProperty(prop,val.replace(/var\(--text-color\)/g,textColor));
        }
      }
    });
  }

  // --- Effetto sfondo inline
  const effSfondo = effettiSfondo.find(e => String(e.id) === String(selectEffettoSfondo.value));
  if(effSfondo && effSfondo.css){
    let sfondoCss = effSfondo.css
      .replace(/var\(--bg-color\)/g, primary)
      .replace(/var\(--bg-color-rgb\)/g, bgRgb)
      .replace(/var\(--bg-color-secondario\)/g, secondary)
      .replace(/var\(--bg-color-secondario-rgb\)/g, bgSecondarioRgb);

    sfondoCss.split(";").forEach(rule=>{
      if(rule.trim()){
        const [propRaw,...valParts] = rule.split(":");
        const prop = propRaw && propRaw.trim();
        const val = valParts.join(":") && valParts.join(":").trim();
        if(prop && val){
          anteprimaDiv.style.setProperty(prop,val);
        }
      }
    });
  }
}

// --- Event listeners per input
[inputSfondo,inputSfondoSecondario,inputTesto].forEach(el => el.addEventListener("input", aggiornaAnteprima));
[selectFont,selectEffettoSfondo,selectEffettoScritta].forEach(el => el.addEventListener("change", aggiornaAnteprima));

// --- Aggiorna evento
document.getElementById("aggiornaEventoBtn").addEventListener("click", async ()=>{
  const fotoFile = document.getElementById("fotoEvento").files[0];
  const formData = new FormData();
  formData.append("nome_evento", nomeEventoParam);
  formData.append("admin", adminParam);
  if(fotoFile) formData.append("foto_evento", fotoFile);
  formData.append("sfondo", inputSfondo.value);
  formData.append("sfondo_secondario", inputSfondoSecondario.value);
  formData.append("testo", inputTesto.value);
  formData.append("font", selectFont.value);
  formData.append("effetto_sfondo", selectEffettoSfondo.value||"");
  formData.append("effetto_scritta", selectEffettoScritta.value||"");

  try {
    const res = await fetchConAuth("https://matrimonioapp.ew.r.appspot.com/admin/aggiorna_evento", {
      method:"POST",
      body: formData
    });
    const data = await res.json();
    document.getElementById("msg").innerText = data.success ? "Evento aggiornato!" : "Errore: "+(data.error||"imprevisto");
    if(data.success) setTimeout(()=>window.location.href="index.html",1000);
  } catch(err){
    console.error(err);
    document.getElementById("msg").innerText = "Errore aggiornamento evento.";
  }
});

// --- Onload
window.onload = async () => {
  await checkAuth();
  await caricaFontsEdEffetti();
  await caricaDatiEvento();
};
</script>
</body>
</html>
