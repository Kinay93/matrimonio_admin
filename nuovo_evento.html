<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Nuovo Evento</title>
<link rel="stylesheet" href="style.css">
<style>
/* (il tuo CSS rimane praticamente invariato) */
body {
    margin: 0;
    font-family: sans-serif;
    display: flex;
    flex-direction: column;
    min-height: 100vh;
}
.container { display:flex; flex:1; height:100vh; overflow:hidden; }
.form-col { flex:1; padding:20px; overflow-y:auto; border-right:1px solid #ccc; box-sizing:border-box; }
.anteprima-col { flex:1; padding:20px; position:sticky; top:0; height:100vh; box-sizing:border-box; }
#anteprima { width:80%; height:80%; max-width:400px; max-height:400px; border-radius:12px; overflow:hidden;
    display:flex; align-items:center; justify-content:center; transition: background 200ms ease, color 200ms ease; }
#anteprimaFoto { width:150px; height:150px; border-radius:10px; object-fit:cover; background:#eee; }
#anteprimaTesto { position:absolute; top:12px; left:12px; font-size:24px; }
footer { position:fixed; bottom:0; left:0; right:0; display:flex; justify-content:space-around; padding:10px; background:rgba(255,255,255,0.9); box-shadow:0 -2px 5px rgba(0,0,0,0.1); }
footer a { text-decoration:none; background:#c235d4; color:white; padding:10px 20px; border-radius:20px; }
</style>

<!-- Carica la navbar dinamica (defer per eseguire prima del nostro script inline se possibile) -->
<script src="navbar.js" defer></script>
</head>
<body>
  <!-- Placeholder per navbar -->
  <div id="navbar-placeholder"></div>

  <header>
    <h1>Nuovo Evento</h1>
  </header>

<div class="container">
    <div class="form-col">
        <label>Nome evento:<input type="text" id="nomeEvento" placeholder="Nome evento"></label>
        <label>Foto evento:<input type="file" id="fotoEvento" accept="image/*"></label>

        <!-- hidden tipo (server richiede "tipo") -->
        <input type="hidden" id="tipoEvento" value="evento">

        <label>Colore sfondo primario:<input type="color" id="colorSfondo" value="#ffffff"></label>
        <label>Colore sfondo secondario:<input type="color" id="colorSfondoSecondario" value="#eeeeee"></label>
        <label>Colore testo:<input type="color" id="colorTesto" value="#000000"></label>
        <label>Font:<select id="fontScelto"></select></label>
        <label>Effetto sfondo:<select id="effettoSfondo"></select></label>
        <label>Effetto scritta:<select id="effettoScritta"></select></label>
        <button id="creaEventoBtn">Crea Evento</button>
        <div id="msg" style="margin-top:10px;font-weight:bold;"></div>
    </div>

    <div class="anteprima-col">
        <h3>Anteprima</h3>
        <div id="anteprima" style="background:linear-gradient(135deg,#ffffff,#eeeeee); position:relative;">
            <img id="anteprimaFoto" src="" alt="Foto Evento">
            <span id="anteprimaTesto">Titolo Evento</span>
        </div>
    </div>
</div>

<footer>
    <a href="index.html" id="home-btn">Menu</a>
</footer>

<script>
async function checkAuth() {
    const token = localStorage.getItem("auth_token");
    if(!token) return window.location.href = "login.html";
    try {
        const res = await fetch("https://matrimonioapp.ew.r.appspot.com/me", {
            headers: { "Authorization": "Bearer " + token }
        });
        const data = await res.json();
        if(!data.success){
            localStorage.removeItem("auth_token");
            localStorage.removeItem("admin_username");
            window.location.href = "login.html";
        }
    } catch(err){
        localStorage.removeItem("auth_token");
        localStorage.removeItem("admin_username");
        window.location.href = "login.html";
    }
}

// Attende che la navbar sia caricata
function waitForNavbar(callback){
    const interval = setInterval(() => {
        const userBtn = document.getElementById('userBtn');
        const dropdownMenu = document.getElementById('dropdownMenu');
        const temaNav = document.getElementById('navTemaAdmin');
        if(userBtn && dropdownMenu && temaNav){
            clearInterval(interval);
            callback(userBtn, dropdownMenu, temaNav);
        }
    }, 50);
}

// Inizializza dropdown navbar e evidenzia pagina corrente
waitForNavbar((userBtn, dropdownMenu, temaNav) => {
    // Dropdown username
    userBtn.querySelector('span').textContent = localStorage.getItem('admin_username') || 'Admin';
    userBtn.addEventListener('click', () => {
        dropdownMenu.style.display = dropdownMenu.style.display === 'block' ? 'none' : 'block';
    });
    window.addEventListener('click', (e) => {
        if(!userBtn.contains(e.target) && !dropdownMenu.contains(e.target)){
            dropdownMenu.style.display = 'none';
        }
    });

    // Evidenzia pagina corrente
    temaNav.classList.add('active');

    // Logout
    const logoutBtn = document.getElementById('logoutBtn');
    if(logoutBtn){
        logoutBtn.addEventListener('click', () => {
            localStorage.removeItem("auth_token");
            localStorage.removeItem("admin_username");
            window.location.href = "login.html";
        });
    }
});

// Funzioni tema admin
const previewBox = document.getElementById('previewBox');
const bgColorInput = document.getElementById('bgColorInput');
const bgColorSecondarioInput = document.getElementById('bgColorSecondarioInput');
const textColorInput = document.getElementById('textColorInput');
const fontsSelect = document.getElementById('fontsSelect');
const effettiScrittaSelect = document.getElementById('effettiScrittaSelect');
const effettiSfondoSelect = document.getElementById('effettiSfondoSelect');
const saveBtn = document.getElementById('saveBtn');

let effettiScritta = [];
let effettiSfondo = [];
let fonts = [];

function hexToRgb(hex) {
  hex = hex.replace('#','');
  if(hex.length === 3) hex = hex.split('').map(c => c+c).join('');
  const bigint = parseInt(hex,16);
  const r = (bigint >> 16) & 255;
  const g = (bigint >> 8) & 255;
  const b = bigint & 255;
  return `${r}, ${g}, ${b}`;
}

// Carica fonts ed effetti
async function caricaFontsEdEffetti() {
  try {
    const token = localStorage.getItem("auth_token");
    const resFonts = await fetch("https://matrimonioapp.ew.r.appspot.com/admin/get_fonts", {
        headers: { "Authorization": "Bearer " + token }
    });
    const dataFonts = await resFonts.json();
    fonts = dataFonts.fonts;
    fontsSelect.innerHTML = '';
    fonts.forEach(f => {
      const option = document.createElement('option');
      option.value = f.css_family;
      option.textContent = f.name;
      fontsSelect.appendChild(option);
    });

    const resEffetti = await fetch("https://matrimonioapp.ew.r.appspot.com/admin/get_effetti", {
        headers: { "Authorization": "Bearer " + token }
    });
    const dataEffetti = await resEffetti.json();
    effettiScritta = dataEffetti.scritta;
    effettiSfondo = dataEffetti.sfondo;

    effettiScrittaSelect.innerHTML = '';
    effettiScritta.forEach(e => {
      const option = document.createElement('option');
      option.value = e.id;
      option.textContent = e.name;
      effettiScrittaSelect.appendChild(option);
    });

    effettiSfondoSelect.innerHTML = '';
    effettiSfondo.forEach(e => {
      const option = document.createElement('option');
      option.value = e.id;
      option.textContent = e.name;
      effettiSfondoSelect.appendChild(option);
    });
  } catch(e){ console.error(e); }
}

// Anteprima tema
function aggiornaAnteprima() {
  previewBox.style.cssText = '';
  previewBox.style.fontFamily = fontsSelect.value;
  previewBox.style.color = textColorInput.value;
  previewBox.style.display = 'flex';
  previewBox.style.alignItems = 'center';
  previewBox.style.justifyContent = 'center';
  previewBox.style.fontSize = '24px';
  previewBox.style.minHeight = '150px';
  previewBox.style.padding = '20px';

  const bgRgb = hexToRgb(bgColorInput.value);
  const bgSecondarioRgb = hexToRgb(bgColorSecondarioInput.value);

  previewBox.style.setProperty('--bg-color', bgColorInput.value);
  previewBox.style.setProperty('--bg-color-rgb', bgRgb);
  previewBox.style.setProperty('--bg-color-secondario', bgColorSecondarioInput.value);
  previewBox.style.setProperty('--bg-color-secondario-rgb', bgSecondarioRgb);

  const effScritta = effettiScritta.find(e => e.id === effettiScrittaSelect.value);
  if(effScritta && effScritta.css){
    let scrittaCss = effScritta.css.replace(/var\(--text-color\)/g, textColorInput.value);
    scrittaCss.split(';').forEach(rule => {
      if(rule.trim()){
        let [prop, ...rest] = rule.split(':');
        let val = rest.join(':');
        if(prop && val) previewBox.style.setProperty(prop.trim(), val.trim());
      }
    });
  }

  const effSfondo = effettiSfondo.find(e => e.id === effettiSfondoSelect.value);
  let overlayColor = `rgba(${bgRgb},0.3)`;
  if(effSfondo && effSfondo.css){
    let sfondoCss = effSfondo.css
      .replace(/var\(--bg-color\)/g, bgColorInput.value)
      .replace(/var\(--bg-color-rgb\)/g, bgRgb)
      .replace(/var\(--bg-color-secondario\)/g, bgColorSecondarioInput.value)
      .replace(/var\(--bg-color-secondario-rgb\)/g, bgSecondarioRgb);

    sfondoCss.split(';').forEach(rule => {
      if(rule.trim()){
        let [prop, ...rest] = rule.split(':');
        let val = rest.join(':');
        if(prop && val) previewBox.style.setProperty(prop.trim(), val.trim());
      }
    });

    const bgImageMatch = sfondoCss.match(/url\(([^)]+)\)/);
    if(bgImageMatch){
      previewBox.style.position = 'relative';
      if(!previewBox.querySelector('.overlay')){
        const overlay = document.createElement('div');
        overlay.className = 'overlay';
        overlay.style.backgroundColor = overlayColor;
        previewBox.appendChild(overlay);
      } else {
        previewBox.querySelector('.overlay').style.backgroundColor = overlayColor;
      }
    } else {
      const existingOverlay = previewBox.querySelector('.overlay');
      if(existingOverlay) existingOverlay.remove();
    }
  }
}

[bgColorInput, bgColorSecondarioInput, textColorInput, fontsSelect, effettiScrittaSelect, effettiSfondoSelect]
  .forEach(el => el.addEventListener('input', aggiornaAnteprima));

saveBtn.addEventListener('click', async () => {
  const formData = new FormData();
  formData.append('sfondo', bgColorInput.value);
  formData.append('sfondo_secondario', bgColorSecondarioInput.value);
  formData.append('testo', textColorInput.value);
  formData.append('font', fontsSelect.value);
  formData.append('effetto_scritta', effettiScrittaSelect.value);
  formData.append('effetto_sfondo', effettiSfondoSelect.value);

  try {
    const token = localStorage.getItem("auth_token");
    const username = localStorage.getItem('admin_username') || 'default';
    const res = await fetch(`https://matrimonioapp.ew.r.appspot.com/admin/crea_evento?admin=${encodeURIComponent(username)}`, {
      method: 'POST',
      headers: { "Authorization": "Bearer " + token },
      body: formData
    });
    const data = await res.json();
    if(data.success) alert('evento salvato!');
    else alert('Errore salvataggio tema');
  } catch(e) { console.error('Errore nel salvataggio dell\'evento:', e); }
});

window.addEventListener('DOMContentLoaded', async () => {
  await checkAuth();
  await caricaFontsEdEffetti();
  aggiornaAnteprima();
});
</script>
</body>
</html>
