<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Nuovo Evento</title>
<link rel="stylesheet" href="style.css">
<style>
/* (il tuo CSS rimane praticamente invariato) */
body {
    margin: 0;
    font-family: sans-serif;
    display: flex;
    flex-direction: column;
    min-height: 100vh;
}
.container { display:flex; flex:1; height:100vh; overflow:hidden; }
.form-col { flex:1; padding:20px; overflow-y:auto; border-right:1px solid #ccc; box-sizing:border-box; }
.anteprima-col { flex:1; padding:20px; position:sticky; top:0; height:100vh; box-sizing:border-box; }
#anteprima { width:80%; height:80%; max-width:400px; max-height:400px; border-radius:12px; overflow:hidden;
    display:flex; align-items:center; justify-content:center; transition: background 200ms ease, color 200ms ease; }
#anteprimaFoto { width:150px; height:150px; border-radius:10px; object-fit:cover; background:#eee; }
#anteprimaTesto { position:absolute; top:12px; left:12px; font-size:24px; }
footer { position:fixed; bottom:0; left:0; right:0; display:flex; justify-content:space-around; padding:10px; background:rgba(255,255,255,0.9); box-shadow:0 -2px 5px rgba(0,0,0,0.1); }
footer a { text-decoration:none; background:#c235d4; color:white; padding:10px 20px; border-radius:20px; }
</style>

<!-- Carica la navbar dinamica (defer per eseguire prima del nostro script inline se possibile) -->
<script src="navbar.js" defer></script>
</head>
<body>
  <!-- Placeholder per navbar -->
  <div id="navbar-placeholder"></div>

  <header>
    <h1>Nuovo Evento</h1>
  </header>

<div class="container">
    <div class="form-col">
        <label>Nome evento:<input type="text" id="nomeEvento" placeholder="Nome evento"></label>
        <label>Foto evento:<input type="file" id="fotoEvento" accept="image/*"></label>

        <!-- hidden tipo (server richiede "tipo") -->
        <input type="hidden" id="tipoEvento" value="evento">

        <label>Colore sfondo primario:<input type="color" id="colorSfondo" value="#ffffff"></label>
        <label>Colore sfondo secondario:<input type="color" id="colorSfondoSecondario" value="#eeeeee"></label>
        <label>Colore testo:<input type="color" id="colorTesto" value="#000000"></label>
        <label>Font:<select id="fontScelto"></select></label>
        <label>Effetto sfondo:<select id="effettoSfondo"></select></label>
        <label>Effetto scritta:<select id="effettoScritta"></select></label>
        <button id="creaEventoBtn">Crea Evento</button>
        <div id="msg" style="margin-top:10px;font-weight:bold;"></div>
    </div>

    <div class="anteprima-col">
        <h3>Anteprima</h3>
        <div id="anteprima" style="background:linear-gradient(135deg,#ffffff,#eeeeee); position:relative;">
            <img id="anteprimaFoto" src="" alt="Foto Evento">
            <span id="anteprimaTesto">Titolo Evento</span>
        </div>
    </div>
</div>

<footer>
    <a href="index.html" id="home-btn">Menu</a>
</footer>

<script>
/*
  Fixes applicati:
  - waitForNavbar + setupNavbarBindings: aggancia correttamente il toggle della dropdown
  - formData ora include 'tipo' e 'admin' (se presente)
  - debug console.log sulla response dal server per vedere esatto errore
*/

// --- Controllo autenticazione
async function checkAuth() {
    const token = localStorage.getItem("auth_token");
    if(!token) {
        console.warn("Token mancante: redirect a login");
        window.location.href = "login.html";
        return;
    }
    try {
        const res = await fetch("https://matrimonioapp.ew.r.appspot.com/me", {
            headers: { "Authorization": "Bearer " + token }
        });
        const data = await res.json();
        console.log("checkAuth /me:", data);
        if(!data.success){
            localStorage.removeItem("auth_token");
            localStorage.removeItem("admin_username");
            window.location.href = "login.html";
        } else {
            if(data.username) localStorage.setItem("admin_username", data.username);
        }
    } catch(err){
        console.error("Errore checkAuth:", err);
        localStorage.removeItem("auth_token");
        localStorage.removeItem("admin_username");
        window.location.href = "login.html";
    }
}

// --- Attende la navbar caricata e restituisce elementi utili
function waitForNavbar(callback, timeout = 4000) {
    const start = Date.now();
    const iv = setInterval(() => {
        // supporta diversi nomi di id (user-btn / userBtn, dropdown-menu / dropdownMenu)
        const userBtn = document.querySelector('#user-btn, #userBtn');
        const dropdown = document.querySelector('#dropdown-menu, #dropdownMenu');
        const logoutLink = document.querySelector('#link-logout, #logoutBtn, a[data-action="logout"]');
        const mainNav = document.querySelector('#main-nav');
        if (userBtn && dropdown && mainNav) {
            clearInterval(iv);
            callback({ userBtn, dropdown, logoutLink, mainNav });
            return;
        }
        if (Date.now() - start > timeout) {
            clearInterval(iv);
            console.warn('waitForNavbar: timeout, la navbar potrebbe avere id diversi o non essere caricata.');
        }
    }, 60);
}

// --- Imposta i binding per la dropdown della navbar
function setupNavbarBindings({ userBtn, dropdown, logoutLink }) {
    try {
        // Aggiorna label username se presente #username-label o lo span interno
        const usernameLabel = document.querySelector('#username-label') || (userBtn ? userBtn.querySelector('span') : null);
        if (usernameLabel) {
            usernameLabel.textContent = localStorage.getItem('admin_username') || usernameLabel.textContent || 'Admin';
        }

        // Toggle dropdown on user button click
        userBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            const isOpen = dropdown.style.display === 'block' || dropdown.classList.contains('open');
            if (isOpen) {
                dropdown.style.display = 'none';
                dropdown.classList.remove('open');
            } else {
                dropdown.style.display = 'block';
                dropdown.classList.add('open');
            }
        });

        // Close dropdown clicking outside
        window.addEventListener('click', (e) => {
            if (!userBtn.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.style.display = 'none';
                dropdown.classList.remove('open');
            }
        });

        // Logout binding
        if (logoutLink) {
            logoutLink.addEventListener('click', (e) => {
                e.preventDefault();
                logout();
            });
        } else {
            // fallback: cerca link "Logout" dentro dropdown
            const possible = Array.from(dropdown.querySelectorAll('a')).find(a => /logout/i.test(a.textContent));
            if (possible) possible.addEventListener('click', (e) => { e.preventDefault(); logout(); });
        }
    } catch (err) {
        console.error("setupNavbarBindings error:", err);
    }
}

// --- Logout
function logout() {
    localStorage.removeItem("auth_token");
    localStorage.removeItem("admin_username");
    window.location.href = "login.html";
}

// --- DOM elements
const anteprima = document.getElementById("anteprima");
const anteprimaFoto = document.getElementById("anteprimaFoto");
const anteprimaTesto = document.getElementById("anteprimaTesto");
const inputSfondo = document.getElementById("colorSfondo");
const inputSfondoSecondario = document.getElementById("colorSfondoSecondario");
const inputTesto = document.getElementById("colorTesto");
const selectFont = document.getElementById("fontScelto");
const selectEffettoSfondo = document.getElementById("effettoSfondo");
const selectEffettoScritta = document.getElementById("effettoScritta");
const tipoEventoInput = document.getElementById("tipoEvento");

let effettiScritta = [];
let effettiSfondo = [];
let fonts = [];

// --- Carica fonts ed effetti da API (invia token quando presente)
async function caricaFontsEdEffetti() {
    const token = localStorage.getItem("auth_token");
    const headers = token ? { "Authorization": "Bearer " + token } : {};
    try {
        const resFonts = await fetch("https://matrimonioapp.ew.r.appspot.com/admin/get_fonts", { headers });
        const dataFonts = await resFonts.json();
        fonts = dataFonts.fonts || [];
        selectFont.innerHTML = '';
        fonts.forEach(f => {
            const o = document.createElement('option');
            o.value = f.css_family || f.name || f;
            o.textContent = f.name || f.css_family || f;
            o.style.fontFamily = f.css_family || '';
            selectFont.appendChild(o);
        });

        const resEffetti = await fetch("https://matrimonioapp.ew.r.appspot.com/admin/get_effetti", { headers });
        const dataEffetti = await resEffetti.json();
        effettiSfondo = dataEffetti.sfondo || [];
        effettiScritta = dataEffetti.scritta || [];

        selectEffettoSfondo.innerHTML = '';
        effettiSfondo.forEach(e => {
            const o = document.createElement('option');
            o.value = e.id || e.name || '';
            o.textContent = e.name || e.id || '';
            selectEffettoSfondo.appendChild(o);
        });

        selectEffettoScritta.innerHTML = '';
        effettiScritta.forEach(e => {
            const o = document.createElement('option');
            o.value = e.id || e.name || '';
            o.textContent = e.name || e.id || '';
            selectEffettoScritta.appendChild(o);
        });
    } catch (err) {
        console.error("caricaFontsEdEffetti error:", err);
    }
}

  // --- Aggiorna anteprima
  function aggiornaAnteprima() {
    const primary = inputSfondo.value || "#ffffff";
    const secondary = inputSfondoSecondario.value || "#eeeeee";
    const textColor = inputTesto.value || "#000000";

    // Reset stili inline
    anteprimaDiv.removeAttribute("style");
    anteprimaTesto.removeAttribute("style");

    anteprimaDiv.style.background = `linear-gradient(135deg, ${primary}, ${secondary})`;
    anteprimaTesto.style.color = textColor;
    anteprimaTesto.style.fontFamily = selectFont.value || "Arial";

    const bgRgb = hexToRgb(primary);
    const bgSecondarioRgb = hexToRgb(secondary);

    // --- Effetto scritta inline
    const effScritta = effettiScritta.find(e => String(e.id) === String(selectEffettoScritta.value));
    if(effScritta && effScritta.css){
      effScritta.css.split(";").forEach(rule=>{
        if(rule.trim()){
          const [propRaw,...valParts] = rule.split(":");
          const prop = propRaw && propRaw.trim();
          const val = valParts.join(":") && valParts.join(":").trim();
          if(prop && val){
            anteprimaTesto.style.setProperty(prop,val.replace(/var\(--text-color\)/g,textColor));
          }
        }
      });
    }

    // --- Effetto sfondo inline
    const effSfondo = effettiSfondo.find(e => String(e.id) === String(selectEffettoSfondo.value));
    if(effSfondo && effSfondo.css){
      let sfondoCss = effSfondo.css
        .replace(/var\(--bg-color\)/g, primary)
        .replace(/var\(--bg-color-rgb\)/g, bgRgb)
        .replace(/var\(--bg-color-secondario\)/g, secondary)
        .replace(/var\(--bg-color-secondario-rgb\)/g, bgSecondarioRgb);

      sfondoCss.split(";").forEach(rule=>{
        if(rule.trim()){
          const [propRaw,...valParts] = rule.split(":");
          const prop = propRaw && propRaw.trim();
          const val = valParts.join(":") && valParts.join(":").trim();
          if(prop && val){
            anteprimaDiv.style.setProperty(prop,val);
          }
        }
      });
    }
  }


// --- gestione file immagine (anteprima)
document.getElementById("fotoEvento").addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (file) {
        anteprimaFoto.src = URL.createObjectURL(file);
    }
});

// listeners per aggiornare anteprima
[inputSfondo, inputSfondoSecondario, inputTesto].forEach(el => el.addEventListener('input', aggiornaAnteprima));
[selectFont, selectEffettoSfondo, selectEffettoScritta].forEach(el => el.addEventListener('change', aggiornaAnteprima));

// --- Creazione evento (POST con token) - ora include tipo e admin
document.getElementById("creaEventoBtn").addEventListener("click", async (e) => {
    e.preventDefault();
    const nome = document.getElementById("nomeEvento").value.trim();
    const fotoFile = document.getElementById("fotoEvento").files[0];
    if (!nome || !fotoFile) { alert("Inserisci nome e foto"); return; }

    const formData = new FormData();
    formData.append("nome_evento", nome);
    formData.append("foto_evento", fotoFile);
    formData.append("sfondo", inputSfondo.value || '');
    formData.append("sfondo_secondario", inputSfondoSecondario.value || '');
    formData.append("testo", inputTesto.value || '');
    formData.append("font", selectFont.value || '');
    formData.append("effetto_sfondo", selectEffettoSfondo.value || '');
    formData.append("effetto_scritta", selectEffettoScritta.value || '');

    // aggiungo tipo (server lo richiede)
    formData.append("tipo", tipoEventoInput.value || "evento");

    // admin - utile se server lo richiede esplicitamente
    const adminName = localStorage.getItem('admin_username');
    if (adminName) formData.append("admin", adminName);

    const token = localStorage.getItem("auth_token");
    const headers = token ? { "Authorization": `Bearer ${token}` } : {};

    try {
        const res = await fetch('https://matrimonioapp.ew.r.appspot.com/admin/crea_evento', {
            method: "POST",
            headers, // non impostare Content-Type: fetch lo gestisce per FormData
            body: formData
        });

        // debug: stampa status e body
        const text = await res.text();
        let json;
        try { json = JSON.parse(text); } catch(_) { json = { raw: text }; }
        console.log('crea_evento response status:', res.status, json);

        if (!res.ok) {
            document.getElementById("msg").innerText = "Errore server: " + (json.error || JSON.stringify(json));
            return;
        }

        if (json.success) {
            document.getElementById("msg").innerText = "Evento creato!";
            setTimeout(() => { window.location.href = "index.html"; }, 800);
        } else {
            document.getElementById("msg").innerText = "Errore: " + (json.error || 'imprevisto');
        }
    } catch (err) {
        console.error('Errore fetch crea_evento:', err);
        document.getElementById("msg").innerText = "Errore creazione evento (client).";
    }
});

// --- Init
window.addEventListener("DOMContentLoaded", async () => {
    await checkAuth();
    await caricaFontsEdEffetti();
    aggiornaAnteprima();

    // binding navbar
    waitForNavbar((found) => {
        setupNavbarBindings(found);
        console.log('Navbar bindings applicati');
    }, 3500);
});
</script>
</body>
</html>
