<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Modifica Evento</title>
  <link rel="stylesheet" href="style.css">
  <script src="navbar.js" defer></script>
  <script src="script.js" defer></script>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    .container {
      display: flex;
      flex: 1;
      height: 100vh;
      overflow: hidden;
    }

    .form-col {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding: 20px;
      overflow-y: auto;
      border-right: 1px solid #ccc;
      box-sizing: border-box;
    }

    .anteprima-col {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      position: sticky;
      top: 0;
      height: 100vh;
      box-sizing: border-box;
    }

    #anteprima {
      width: 80%;
      height: 80%;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid #ccc;
      margin-top: 20px;
      position: relative;
      max-width: 400px;
      max-height: 400px;
    }

    #anteprimaFoto {
      width: 150px;
      height: 150px;
      background-color: #ddd;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: #666;
      overflow: hidden;
    }

    #anteprimaFoto img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    #anteprimaTesto {
      position: absolute;
      top: 10px;
      left: 10px;
      font-size: 24px;
    }

    footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      display: flex;
      justify-content: space-around;
      padding: 10px;
      background-color: rgba(255,255,255,0.9);
      box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
    }

    footer a {
      text-decoration: none;
      background: #c235d4;
      color: white;
      padding: 10px 20px;
      border-radius: 20px;
      font-weight: bold;
      transition: background 0.2s ease;
    }

    footer a:hover {
      background: #a91eb9;
    }

    @media (max-width: 1024px) {
      .container { flex-direction: column; height: 100vh; }
      .anteprima-col { width: 100%; height: 40vh; position: fixed; top: 0; left: 0; right: 0; background: white; z-index: 1000; border-bottom: 1px solid #ccc; }
      .form-col { margin-top: 40vh; flex: 1; overflow-y: auto; border-right: none; border-bottom: 1px solid #ccc; }
      #anteprima { width: 80%; height: 80%; max-width: none; max-height: none; }
    }

    @media (max-width: 480px) {
      .anteprima-col { height: 35vh; }
      .form-col { margin-top: 35vh; }
    }

    @media (max-width: 768px) {
      footer { flex-direction: column; gap: 10px; }
      footer a { width: 80%; text-align: center; }
    }
  </style>
</head>
<body>
  <div id="navbar-placeholder"></div>

  <div class="container">
    <div class="form-col">
      <label>Nome evento:<input type="text" id="nomeEvento" disabled></label>
      <label>Foto evento:<input type="file" id="fotoEvento"></label>
      <label>Colore sfondo primario:<input type="color" id="sfondo"></label>
      <label>Colore sfondo secondario:<input type="color" id="sfondoSecondario"></label>
      <label>Colore testo:<input type="color" id="testo"></label>
      <label>Font:<select id="font"></select></label>
      <label>Effetto sfondo:<select id="effettoSfondo"></select></label>
      <label>Effetto scritta:<select id="effettoScritta"></select></label>
      <button id="aggiornaEventoBtn">Aggiorna evento</button>
      <div id="msg"></div>
    </div>

    <div class="anteprima-col">
      <h3>Anteprima</h3>
      <div id="anteprima">
        <div id="anteprimaFoto">Foto</div>
        <span id="anteprimaTesto">Titolo Evento</span>
      </div>
    </div>
  </div>

  <footer>
    <a href="index.html" id="home-btn">Home</a>
  </footer>

 <script>
  // --- Controllo autenticazione
  async function checkAuth() {
    const token = localStorage.getItem("auth_token");
    if(!token) window.location.href = "login.html";

    try {
      const res = await fetch("https://matrimonioapp.ew.r.appspot.com/me", { 
        headers: { "Authorization": "Bearer " + token }
      });
      const data = await res.json();
      if(!data.success){
        localStorage.removeItem("auth_token");
        localStorage.removeItem("admin_username");
        window.location.href = "login.html";
      }
    } catch(err){
      localStorage.removeItem("auth_token");
      localStorage.removeItem("admin_username");
      window.location.href = "login.html";
    }
  }

  // --- Utils
  function hexToRgb(hex) {
    hex = hex.replace('#','');
    if(hex.length === 3) hex = hex.split('').map(c => c+c).join('');
    const bigint = parseInt(hex,16);
    const r = (bigint >> 16) & 255;
    const g = (bigint >> 8) & 255;
    const b = bigint & 255;
    return `${r}, ${g}, ${b}`;
  }

  // --- Parametri URL
  const params = new URLSearchParams(window.location.search);
  const nomeEventoParam = params.get("evento");
  const adminParam = params.get("admin") || localStorage.getItem("admin_username");

  // --- Elementi DOM
  const anteprimaDiv = document.getElementById("anteprima");
  const anteprimaTesto = document.getElementById("anteprimaTesto");
  const anteprimaFoto = document.getElementById("anteprimaFoto");

  const inputSfondo = document.getElementById("sfondo");
  const inputSfondoSecondario = document.getElementById("sfondoSecondario");
  const inputTesto = document.getElementById("testo");
  const selectFont = document.getElementById("font");
  const selectEffettoSfondo = document.getElementById("effettoSfondo");
  const selectEffettoScritta = document.getElementById("effettoScritta");

  let effettiScritta = [];
  let effettiSfondo = [];
  let fonts = [];

  // --- Carica fonts ed effetti
  async function caricaFontsEdEffetti() {
    try {
      const token = localStorage.getItem("auth_token");
      const resFonts = await fetch("https://matrimonioapp.ew.r.appspot.com/admin/get_fonts", { headers: { "Authorization": "Bearer " + token }});
      const dataFonts = await resFonts.json();
      fonts = dataFonts.fonts || [];
      selectFont.innerHTML = "";
      fonts.forEach(f=>{
        const o=document.createElement("option");
        o.value=f.css_family || f;
        o.textContent=f.name || f;
        o.style.fontFamily = f.css_family || f;
        selectFont.appendChild(o);
      });

      const resEffetti = await fetch("https://matrimonioapp.ew.r.appspot.com/admin/get_effetti", { headers: { "Authorization": "Bearer " + token }});
      const dataEffetti = await resEffetti.json();
      effettiSfondo = dataEffetti.sfondo || [];
      effettiScritta = dataEffetti.scritta || [];

      selectEffettoSfondo.innerHTML = '';
      effettiSfondo.forEach(f=>{
        const o=document.createElement("option");
        o.value=f.id || f;
        o.textContent=f.name || f;
        selectEffettoSfondo.appendChild(o);
      });

      selectEffettoScritta.innerHTML = '';
      effettiScritta.forEach(f=>{
        const o=document.createElement("option");
        o.value=f.id || f;
        o.textContent=f.name || f;
        selectEffettoScritta.appendChild(o);
      });
    } catch(e){ console.error(e); }
  }

  // --- Carica dati evento
  async function caricaDatiEvento() {
    try {
      const token = localStorage.getItem("auth_token");
      const res = await fetch(`https://matrimonioapp.ew.r.appspot.com/admin/get_evento?evento=${encodeURIComponent(nomeEventoParam)}&admin=${encodeURIComponent(adminParam)}`, {
        headers: { "Authorization": "Bearer " + token }
      });
      const data = await res.json();
      if(data.error){ alert("Evento non trovato"); return; }

      document.getElementById("nomeEvento").value = data.titolo_index || "";
      if(data.foto_url){
        anteprimaFoto.innerHTML = `<img src="${data.foto_url}" alt="Foto Evento">`;
      }

      inputSfondo.value = data.sfondo || "#ffffff";
      inputSfondoSecondario.value = data.sfondo_secondario || "#eeeeee";
      inputTesto.value = data.testo || "#000000";
      selectFont.value = data.font || "Arial";
      selectEffettoSfondo.value = data.effetto_sfondo || "";
      selectEffettoScritta.value = data.effetto_scritta || "";

      anteprimaTesto.textContent = data.titolo_index || "Titolo Evento";
      aggiornaAnteprima();
    } catch(err){
      console.error("Errore caricamento dati evento:", err);
    }
  }

  // --- Aggiorna anteprima
  function aggiornaAnteprima() {
    anteprimaDiv.style.cssText = '';
    anteprimaTesto.style.cssText = '';

    const primary = inputSfondo.value || "#ffffff";
    const secondary = inputSfondoSecondario.value || "#eeeeee";

    anteprimaDiv.style.background = `linear-gradient(135deg, ${primary}, ${secondary})`;
    anteprimaTesto.style.color = inputTesto.value || "#000000";
    anteprimaTesto.style.fontFamily = selectFont.value || "Arial";

    if(selectEffettoSfondo.value){
      anteprimaDiv.className = selectEffettoSfondo.value;
    }
    if(selectEffettoScritta.value){
      anteprimaTesto.className = selectEffettoScritta.value;
    }
  }

  // --- Event listeners per input
  [inputSfondo,inputSfondoSecondario,inputTesto].forEach(el => el.addEventListener("input", aggiornaAnteprima));
  [selectFont,selectEffettoSfondo,selectEffettoScritta].forEach(el => el.addEventListener("change", aggiornaAnteprima));

  // --- Aggiorna evento
  document.getElementById("aggiornaEventoBtn").addEventListener("click", async ()=>{
    const fotoFile = document.getElementById("fotoEvento").files[0];
    const formData = new FormData();
    formData.append("nome_evento", nomeEventoParam);
    formData.append("admin", adminParam);
    if(fotoFile) formData.append("foto_evento", fotoFile);
    formData.append("sfondo", inputSfondo.value);
    formData.append("sfondo_secondario", inputSfondoSecondario.value);
    formData.append("testo", inputTesto.value);
    formData.append("font", selectFont.value);
    formData.append("effetto_sfondo", selectEffettoSfondo.value||"");
    formData.append("effetto_scritta", selectEffettoScritta.value||"");

    const token = localStorage.getItem("auth_token");

    try {
      const res = await fetch("https://matrimonioapp.ew.r.appspot.com/admin/aggiorna_evento", {
        method:"POST",
        headers: { "Authorization": `Bearer ${token}` },
        body: formData
      });
      const data = await res.json();
      document.getElementById("msg").innerText = data.success ? "Evento aggiornato!" : "Errore: "+(data.error||"imprevisto");
      if(data.success) setTimeout(()=>window.location.href="index.html",1000);
    } catch(err){
      console.error(err);
      document.getElementById("msg").innerText = "Errore aggiornamento evento.";
    }
  });

  // --- Onload
  window.onload = async () => {
    await checkAuth();
    await caricaFontsEdEffetti();
    await caricaDatiEvento();
  };
</script>


</body>
</html>
