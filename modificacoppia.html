<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Aggiorna Coppia</title>
</head>
<body>
    <h1>Aggiorna Coppia</h1>

    <label for="nomeCoppia">Nome della Coppia:</label>
    <input type="text" id="nomeCoppia" disabled>

    <label for="fotoCoppia">Foto della coppia:</label>
    <input type="file" id="fotoCoppia">

    <label for="titoloIndex">Titolo della pagina:</label>
    <input type="text" id="titoloIndex">

    <label for="colorSfondo">Colore sfondo:</label>
    <input type="color" id="colorSfondo">

    <label for="colorTesto">Colore testo:</label>
    <input type="color" id="colorTesto">

    <button id="aggiornaCoppiaBtn">Aggiorna configurazione</button>

    <div id="msg"></div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const coppia = params.get("coppia");

        async function caricaCoppia() {
            const res = await fetch('https://matrimonioapp.ew.r.appspot.com/upload?coppia=${nome}');
            const data = await res.json();
            if (data.error) {
                document.getElementById("msg").innerText = data.error;
                return;
            }

            document.getElementById("nomeCoppia").value = data.nome_coppia;
            document.getElementById("titoloIndex").value = data.titolo_index || "";
            document.getElementById("colorSfondo").value = data.colori?.sfondo || "#ffffff";
            document.getElementById("colorTesto").value = data.colori?.testo || "#000000";
        }

        document.getElementById("aggiornaCoppiaBtn").addEventListener("click", async () => {
            const fotoFile = document.getElementById("fotoCoppia").files[0];
            let fotoUrl;

            if (fotoFile) {
                const formData = new FormData();
                formData.append("foto", fotoFile);
                const res = await fetch('https://matrimonioapp.ew.r.appspot.com/upload?coppia=${nome}', { method: "POST", body: formData });
                const data = await res.json();
                if (!data.success) {
                    document.getElementById("msg").innerText = "Errore upload foto: " + (data.error || "Imprevisto");
                    return;
                }
                fotoUrl = data.files[0].file_url;
            }

            const aggiornaConfig = {
                nome_coppia: coppia,
                titolo_index: document.getElementById("titoloIndex").value,
                foto_url: fotoUrl || undefined,
                colori: {
                    sfondo: document.getElementById("colorSfondo").value,
                    testo: document.getElementById("colorTesto").value,
                    font: "Arial"
                }
            };

            const res = await fetch('https://matrimonioapp.ew.r.appspot.com/upload?coppia=${nome}', {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify(aggiornaConfig)
            });

            const data = await res.json();
            if (data.success) {
                document.getElementById("msg").innerText = "Coppia aggiornata con successo!";
            } else {
                document.getElementById("msg").innerText = "Errore aggiornamento: " + (data.error || "Imprevisto");
            }
        });

        caricaCoppia();
    </script>
</body>
</html>
