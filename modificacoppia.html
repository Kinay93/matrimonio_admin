<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Aggiorna Coppia</title>
</head>
<body>
    <h1>Aggiorna Coppia</h1>

    <label for="nomeCoppia">Nome della Coppia:</label>
    <input type="text" id="nomeCoppia" disabled>

    <label for="fotoCoppia">Foto della coppia:</label>
    <input type="file" id="fotoCoppia">

    <label for="titoloIndex">Titolo della pagina:</label>
    <input type="text" id="titoloIndex">

    <label for="colorSfondo">Colore sfondo:</label>
    <input type="color" id="colorSfondo">

    <label for="colorTesto">Colore testo:</label>
    <input type="color" id="colorTesto">

    <label for="fontScelto">Font del testo:</label>
    <select id="fontScelto"></select>

    <label for="effettoSfondo">Effetto Sfondo:</label>
    <select id="effettoSfondo"></select>

    <label for="effettoScritta">Effetto Scritta:</label>
    <select id="effettoScritta"></select>

    <h3>Anteprima</h3>
    <div id="anteprima" style="width: 100%; height: 100px; display: flex; align-items: center; justify-content: center; border: 1px solid #ccc;">
        <span id="anteprimaTesto">Questo Ã¨ un esempio</span>
    </div>

    <button id="aggiornaCoppiaBtn">Aggiorna configurazione</button>

    <div id="msg"></div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const coppia = params.get("coppia");

        const anteprimaDiv = document.getElementById("anteprima");
        const anteprimaTesto = document.getElementById("anteprimaTesto");
        const inputSfondo = document.getElementById("colorSfondo");
        const inputTesto = document.getElementById("colorTesto");
        const selectFont = document.getElementById("fontScelto");
        const selectEffettoSfondo = document.getElementById("effettoSfondo");
        const selectEffettoScritta = document.getElementById("effettoScritta");

        function aggiornaAnteprima() {
            anteprimaDiv.style.backgroundColor = inputSfondo.value;
            anteprimaTesto.style.color = inputTesto.value;
            anteprimaTesto.style.fontFamily = selectFont.value;
        }

        inputSfondo.addEventListener("input", aggiornaAnteprima);
        inputTesto.addEventListener("input", aggiornaAnteprima);
        selectFont.addEventListener("change", aggiornaAnteprima);

        // Carica dati coppia dal backend
        async function caricaCoppia() {
            try {
                const res = await fetch(
                    `https://matrimonioapp.ew.r.appspot.com/admin/get_coppia?coppia=${encodeURIComponent(coppia)}&t=${Date.now()}`,
                    { cache: "no-store" }
                );
                if (!res.ok) throw new Error("Coppia non trovata");
                const data = await res.json();

                document.getElementById("nomeCoppia").value = data.nome_coppia;
                document.getElementById("titoloIndex").value = data.titolo_index || "";
                inputSfondo.value = (data.colori?.sfondo || "#ffffff").trim();
                inputTesto.value = (data.colori?.testo || "#000000").trim();
                selectFont.value = data.colori?.font || "Arial";

                aggiornaAnteprima();
                document.getElementById("msg").innerText = "";
            } catch(e) {
                document.getElementById("msg").innerText = "Errore caricamento coppia: " + e.message;
            }
        }

        // Carica fonts ed effetti dinamicamente
        async function caricaFontsEdEffetti() {
            try {
                const resFonts = await fetch("https://matrimonioapp.ew.r.appspot.com/admin/get_fonts");
                const dataFonts = await resFonts.json();
                selectFont.innerHTML = "";
                dataFonts.fonts.forEach(f => {
                    const option = document.createElement("option");
                    option.value = f;
                    option.textContent = f;
                    option.style.fontFamily = f;
                    selectFont.appendChild(option);
                });

                const resEffetti = await fetch("https://matrimonioapp.ew.r.appspot.com/admin/get_effetti");
                const dataEffetti = await resEffetti.json();
                selectEffettoSfondo.innerHTML = "";
                selectEffettoScritta.innerHTML = "";

                dataEffetti.sfondo.forEach(f => {
                    const option = document.createElement("option");
                    option.value = f;
                    option.textContent = f;
                    selectEffettoSfondo.appendChild(option);
                });

                dataEffetti.scritta.forEach(f => {
                    const option = document.createElement("option");
                    option.value = f;
                    option.textContent = f;
                    selectEffettoScritta.appendChild(option);
                });

            } catch(e) {
                console.error("Errore caricamento fonts/effetti:", e);
            }
        }

        // Aggiorna dati coppia
        document.getElementById("aggiornaCoppiaBtn").addEventListener("click", async () => {
            const fotoFile = document.getElementById("fotoCoppia").files[0];

            const formData = new FormData();
            formData.append("nome_coppia", coppia);
            formData.append("titolo_index", document.getElementById("titoloIndex").value);
            formData.append("style_css_colore_sfondo", inputSfondo.value);
            formData.append("style_css_colore_testo", inputTesto.value);
            formData.append("style_css_font", selectFont.value);
            // eventualmente inviare anche gli effetti scelti
            formData.append("effetto_sfondo", selectEffettoSfondo.value);
            formData.append("effetto_scritta", selectEffettoScritta.value);

            if (fotoFile) formData.append("foto_coppia", fotoFile);

            try {
                const res = await fetch('https://matrimonioapp.ew.r.appspot.com/admin/aggiorna_coppia', {
                    method: "POST",
                    body: formData
                });
                const data = await res.json();

                if (data.success) {
                    document.getElementById("msg").innerText = "Coppia aggiornata con successo!";
                    caricaCoppia(); // ricarica dati aggiornati senza cache
                } else {
                    document.getElementById("msg").innerText = "Errore aggiornamento: " + (data.error || "Imprevisto");
                }
            } catch(e) {
                document.getElementById("msg").innerText = "Errore aggiornamento: " + e.message;
            }
        });

        // Carica coppia, fonts ed effetti al load
        caricaFontsEdEffetti();
        caricaCoppia();
    </script>
</body>
</html>
