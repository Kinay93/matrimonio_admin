<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Aggiorna Coppia</title>
</head>
<body>
    <h1>Aggiorna Coppia</h1>

    <label for="nomeCoppia">Nome della Coppia:</label>
    <input type="text" id="nomeCoppia" disabled>

    <label for="fotoCoppia">Foto della coppia:</label>
    <input type="file" id="fotoCoppia">

    <label for="titoloIndex">Titolo della pagina:</label>
    <input type="text" id="titoloIndex">

    <label for="colorSfondo">Colore sfondo:</label>
    <input type="color" id="colorSfondo">

    <label for="colorTesto">Colore testo:</label>
    <input type="color" id="colorTesto">

    <label for="fontScelto">Font del testo:</label>
    <select id="fontScelto">
        <option value="Arial" style="font-family: Arial;">Arial</option>
        <option value="Georgia" style="font-family: Georgia;">Georgia</option>
        <option value="Times New Roman" style="font-family: 'Times New Roman';">Times New Roman</option>
        <option value="Courier New" style="font-family: 'Courier New';">Courier New</option>
        <option value="Verdana" style="font-family: Verdana;">Verdana</option>
    </select>

    <h3>Anteprima</h3>
    <div id="anteprima" style="width: 100%; height: 100px; display: flex; align-items: center; justify-content: center; border: 1px solid #ccc;">
        <span id="anteprimaTesto">Questo Ã¨ un esempio</span>
    </div>

    <button id="aggiornaCoppiaBtn">Aggiorna configurazione</button>

    <div id="msg"></div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const coppia = params.get("coppia");

        const anteprimaDiv = document.getElementById("anteprima");
        const anteprimaTesto = document.getElementById("anteprimaTesto");
        const inputSfondo = document.getElementById("colorSfondo");
        const inputTesto = document.getElementById("colorTesto");
        const selectFont = document.getElementById("fontScelto");

        function aggiornaAnteprima() {
            anteprimaDiv.style.backgroundColor = inputSfondo.value;
            anteprimaTesto.style.color = inputTesto.value;
            anteprimaTesto.style.fontFamily = selectFont.value;
        }

        inputSfondo.addEventListener("input", aggiornaAnteprima);
        inputTesto.addEventListener("input", aggiornaAnteprima);
        selectFont.addEventListener("change", aggiornaAnteprima);

        async function caricaCoppia() {
            try {
                const res = await fetch(
                    `https://matrimonioapp.ew.r.appspot.com/admin/get_coppia?coppia=${encodeURIComponent(coppia)}`,
                    { cache: "no-store" }
                );
                if (!res.ok) throw new Error("Coppia non trovata");
                const data = await res.json();

                document.getElementById("nomeCoppia").value = data.nome_coppia;
                document.getElementById("titoloIndex").value = data.titolo_index || "";
                inputSfondo.value = (data.colori?.sfondo || "#ffffff").trim();
                inputTesto.value = (data.colori?.testo || "#000000").trim();
                selectFont.value = data.colori?.font || "Arial";

                aggiornaAnteprima();

                console.log("[DEBUG] Caricati colori:", "sfondo=", inputSfondo.value, "testo=", inputTesto.value, "font=", selectFont.value);
                document.getElementById("msg").innerText = "";
            } catch(e) {
                document.getElementById("msg").innerText = "Errore caricamento coppia: " + e.message;
            }
        }

        document.getElementById("aggiornaCoppiaBtn").addEventListener("click", async () => {
            const fotoFile = document.getElementById("fotoCoppia").files[0];

            const formData = new FormData();
            formData.append("nome_coppia", coppia);
            formData.append("titolo_index", document.getElementById("titoloIndex").value);
            formData.append("style_css_colore_sfondo", inputSfondo.value);
            formData.append("style_css_colore_testo", inputTesto.value);
            formData.append("style_css_font", selectFont.value);
            if (fotoFile) formData.append("foto_coppia", fotoFile);

            console.log("[DEBUG] Invio aggiornamento:", "sfondo=", inputSfondo.value, "testo=", inputTesto.value, "font=", selectFont.value, "titolo=", document.getElementById("titoloIndex").value);

            try {
                const res = await fetch('https://matrimonioapp.ew.r.appspot.com/admin/aggiorna_coppia', {
                    method: "POST",
                    body: formData
                });
                const data = await res.json();

                if (data.success) {
                    document.getElementById("msg").innerText = "Coppia aggiornata con successo!";
                    console.log("[DEBUG] Aggiornamento completato:", data.config);

                    // Aggiorna subito i campi con i dati appena salvati
                    document.getElementById("titoloIndex").value = data.config.titolo_index;
                    inputSfondo.value = data.config.colori.sfondo;
                    inputTesto.value = data.config.colori.testo;
                    selectFont.value = data.config.colori.font;
                    aggiornaAnteprima();

                    // Ricarica dopo 1s per allinearsi allo storage
                    setTimeout(caricaCoppia, 1000);
                } else {
                    document.getElementById("msg").innerText = "Errore aggiornamento: " + (data.error || "Imprevisto");
                }
            } catch(e) {
                document.getElementById("msg").innerText = "Errore aggiornamento: " + e.message;
            }
        });

        caricaCoppia();
    </script>
</body>
</html>
