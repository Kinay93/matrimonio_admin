<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Aggiorna Coppia</title>
</head>
<body>
    <h1>Aggiorna Coppia</h1>

    <label for="nomeCoppia">Nome della Coppia:</label>
    <input type="text" id="nomeCoppia" disabled>

    <label for="fotoCoppia">Foto della coppia:</label>
    <input type="file" id="fotoCoppia">

    <label for="titoloIndex">Titolo della pagina:</label>
    <input type="text" id="titoloIndex">

    <label for="colorSfondo">Colore sfondo:</label>
    <input type="color" id="colorSfondo">

    <label for="colorTesto">Colore testo:</label>
    <input type="color" id="colorTesto">

    <button id="aggiornaCoppiaBtn">Aggiorna configurazione</button>

    <div id="msg"></div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const coppia = params.get("coppia");

        // Carica dati coppia dal backend
        async function caricaCoppia() {
            try {
                const res = await fetch(
                    `https://matrimonioapp.ew.r.appspot.com/admin/get_coppia?coppia=${encodeURIComponent(coppia)}`,
                    { cache: "no-store" }
                );
                if (!res.ok) throw new Error("Coppia non trovata");
                const data = await res.json();

                document.getElementById("nomeCoppia").value = data.nome_coppia;
                document.getElementById("titoloIndex").value = data.titolo_index || "";
                document.getElementById("colorSfondo").value = data.colori?.sfondo || "#ffffff";
                document.getElementById("colorTesto").value = data.colori?.testo || "#000000";

                console.log("[DEBUG] Caricati colori:", 
                            "sfondo=", document.getElementById("colorSfondo").value, 
                            "testo=", document.getElementById("colorTesto").value);

                document.getElementById("msg").innerText = "";
            } catch(e) {
                document.getElementById("msg").innerText = "Errore caricamento coppia: " + e.message;
            }
        }

        // Aggiorna dati coppia
        document.getElementById("aggiornaCoppiaBtn").addEventListener("click", async () => {
            const fotoFile = document.getElementById("fotoCoppia").files[0];

            const formData = new FormData();
            formData.append("nome_coppia", coppia);
            formData.append("titolo_index", document.getElementById("titoloIndex").value);
            formData.append("style_css_colore_sfondo", document.getElementById("colorSfondo").value);
            formData.append("style_css_colore_testo", document.getElementById("colorTesto").value);
            if (fotoFile) formData.append("foto_coppia", fotoFile);

            console.log("[DEBUG] Invio aggiornamento:", 
                        "sfondo=", document.getElementById("colorSfondo").value,
                        "testo=", document.getElementById("colorTesto").value,
                        "titolo=", document.getElementById("titoloIndex").value);

            try {
                const res = await fetch('https://matrimonioapp.ew.r.appspot.com/admin/aggiorna_coppia', {
                    method: "POST",
                    body: formData
                });
                const data = await res.json();

                if (data.success) {
                    document.getElementById("msg").innerText = "Coppia aggiornata con successo!";
                    console.log("[DEBUG] Aggiornamento completato:", data.config);
                    // ricarica i dati aggiornati
                    caricaCoppia();
                } else {
                    document.getElementById("msg").innerText = "Errore aggiornamento: " + (data.error || "Imprevisto");
                }
            } catch(e) {
                document.getElementById("msg").innerText = "Errore aggiornamento: " + e.message;
            }
        });

        // Carica coppia al load
        caricaCoppia();
    </script>
</body>
</html>
